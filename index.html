<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>甲虫库存管理工具 - wenbin出品</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', 'PingFang SC', sans-serif;
        }
        
        body {
            background-color: #f8faf9;
            color: #2c3e2d;
            line-height: 1.6;
            padding: 15px;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(76, 175, 80, 0.05) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(76, 175, 80, 0.05) 0%, transparent 20%);
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
            background-color: white;
            border-radius: 18px;
            box-shadow: 
                0 10px 30px rgba(0, 0, 0, 0.08),
                0 4px 12px rgba(45, 87, 44, 0.05);
            overflow: hidden;
            border: 1px solid rgba(76, 175, 80, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .container:hover {
            box-shadow: 
                0 15px 40px rgba(0, 0, 0, 0.1),
                0 6px 15px rgba(45, 87, 44, 0.08);
        }
        
        .header {
            background: linear-gradient(135deg, #3c763d 0%, #2d572c 100%);
            color: white;
            padding: 25px 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            position: relative;
            overflow: hidden;
            gap: 20px;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            opacity: 0.3;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            gap: 20px;
            z-index: 1;
            flex: 1;
            min-width: 250px;
        }
        
        .logo {
            width: 70px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(255, 255, 255, 0.15);
            border-radius: 16px;
            padding: 12px;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
            flex-shrink: 0;
        }
        
        .logo:hover {
            transform: rotate(5deg) scale(1.05);
            background-color: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        .logo i {
            color: white;
            font-size: 2.5rem;
        }
        
        .title-area {
            display: flex;
            flex-direction: column;
            gap: 6px;
            flex: 1;
        }
        
        .title {
            font-size: 1.8rem;
            font-weight: 800;
            letter-spacing: 0.3px;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
            background: linear-gradient(to right, #ffffff, #f1f8e9);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1.2;
        }
        
        .brand {
            font-size: 0.95rem;
            font-weight: 500;
            opacity: 0.9;
            background-color: rgba(255, 255, 255, 0.2);
            padding: 5px 12px;
            border-radius: 15px;
            display: inline-block;
            max-width: fit-content;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .content {
            padding: 25px;
        }
        
        .section {
            margin-bottom: 35px;
            background-color: #ffffff;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 
                0 6px 20px rgba(0, 0, 0, 0.04),
                0 3px 8px rgba(76, 175, 80, 0.05);
            border: 1px solid rgba(76, 175, 80, 0.08);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .section:hover {
            box-shadow: 
                0 10px 25px rgba(0, 0, 0, 0.06),
                0 4px 12px rgba(76, 175, 80, 0.08);
            border-color: rgba(76, 175, 80, 0.15);
        }
        
        .section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 6px;
            height: 100%;
            background: linear-gradient(to bottom, #4caf50, #2d572c);
            border-radius: 6px 0 0 6px;
        }
        
        .section-title {
            font-size: 1.4rem;
            color: #2d572c;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e8f5e9;
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
        }
        
        .section-title i {
            color: #4caf50;
            background-color: rgba(76, 175, 80, 0.1);
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        label {
            margin-bottom: 8px;
            font-weight: 600;
            color: #3a5a3a;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
        }
        
        label i {
            color: #4caf50;
            font-size: 0.85rem;
        }
        
        .input-hint {
            font-size: 0.8rem;
            color: #8a9c8b;
            margin-top: 5px;
            line-height: 1.4;
        }
        
        input, select {
            padding: 12px 15px;
            border: 2px solid #e0f2e0;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s;
            background-color: #f9fdf9;
            color: #2c3e2d;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #4caf50;
            box-shadow: 
                0 0 0 3px rgba(76, 175, 80, 0.15),
                0 4px 12px rgba(76, 175, 80, 0.1);
            background-color: white;
        }
        
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 15px;
        }
        
        button {
            padding: 12px 22px;
            border: none;
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
            touch-action: manipulation;
            min-height: 44px;
        }
        
        button::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%);
            transform-origin: 50% 50%;
        }
        
        button:focus:not(:active)::after {
            animation: ripple 1s ease-out;
        }
        
        @keyframes ripple {
            0% {
                transform: scale(0, 0);
                opacity: 0.5;
            }
            100% {
                transform: scale(50, 50);
                opacity: 0;
            }
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #4caf50 0%, #3d8b40 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #3d8b40 0%, #2d682f 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(76, 175, 80, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #607d8b 0%, #546e7a 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(96, 125, 139, 0.2);
        }
        
        .btn-secondary:hover {
            background: linear-gradient(135deg, #546e7a 0%, #455a64 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(96, 125, 139, 0.3);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.2);
        }
        
        .btn-danger:hover {
            background: linear-gradient(135deg, #d32f2f 0%, #b71c1c 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(244, 67, 54, 0.3);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(255, 152, 0, 0.2);
        }
        
        .btn-warning:hover {
            background: linear-gradient(135deg, #f57c00 0%, #e65100 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(255, 152, 0, 0.3);
        }
        
        .btn-info {
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.2);
        }
        
        .btn-info:hover {
            background: linear-gradient(135deg, #1976d2 0%, #0d47a1 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(33, 150, 243, 0.3);
        }
        
        .btn-edit {
            background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(156, 39, 176, 0.2);
        }
        
        .btn-edit:hover {
            background: linear-gradient(135deg, #7b1fa2 0%, #6a1b9a 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(156, 39, 176, 0.3);
        }
        
        .btn-metamorphosis {
            background: linear-gradient(135deg, #ff5722 0%, #e64a19 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(255, 87, 34, 0.2);
        }
        
        .btn-metamorphosis:hover {
            background: linear-gradient(135deg, #e64a19 0%, #d84315 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(255, 87, 34, 0.3);
        }
        
        .btn-sale {
            background: linear-gradient(135deg, #673ab7 0%, #512da8 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(103, 58, 183, 0.2);
        }
        
        .btn-sale:hover {
            background: linear-gradient(135deg, #512da8 0%, #4527a0 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(103, 58, 183, 0.3);
        }
        
        .table-container {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid #e0f2e0;
            margin-top: 20px;
            max-height: 600px;
            overflow-y: auto;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
            -webkit-overflow-scrolling: touch;
        }
        
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            min-width: 1200px;
        }
        
        th {
            background: linear-gradient(to bottom, #2d572c, #3c763d);
            color: white;
            text-align: left;
            padding: 16px 12px;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            border-bottom: 2px solid #4caf50;
            font-size: 0.9rem;
            white-space: nowrap;
        }
        
        th:first-child {
            border-top-left-radius: 11px;
        }
        
        th:last-child {
            border-top-right-radius: 11px;
        }
        
        tr:nth-child(even) {
            background-color: #f9fdf9;
        }
        
        tr:hover {
            background-color: #f0f9f0;
        }
        
        td {
            padding: 14px 12px;
            border-bottom: 1px solid #e8f5e9;
            vertical-align: middle;
            transition: background-color 0.2s;
            font-size: 0.9rem;
        }
        
        .action-cell {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .action-btn {
            padding: 8px 12px;
            font-size: 0.8rem;
            border-radius: 8px;
            min-width: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            min-height: 36px;
        }
        
        .group-header {
            background: linear-gradient(to right, #e8f5e9, #c8e6c9) !important;
            font-weight: bold;
            color: #1b5e20;
            font-size: 1rem;
        }
        
        .group-header td {
            padding: 10px 12px;
            border-bottom: 2px solid #4caf50;
        }
        
        .subgroup-header {
            background-color: #f1f8e9 !important;
            font-weight: 600;
            color: #33691e;
            font-size: 0.95rem;
        }
        
        .subgroup-header td {
            padding: 8px 12px;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            vertical-align: middle;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .status-active {
            background-color: #4caf50;
        }
        
        .status-warning {
            background-color: #ff9800;
        }
        
        .status-danger {
            background-color: #f44336;
        }
        
        .status-adult {
            background-color: #9c27b0;
        }
        
        .status-sold {
            background-color: #607d8b;
        }
        
        .footer {
            text-align: center;
            padding: 20px;
            color: #5a7d5c;
            font-size: 0.9rem;
            border-top: 1px solid #e8f5e9;
            background-color: #f9fdf9;
        }
        
        .data-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 25px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 0;
            z-index: 1;
            position: relative;
            flex: 1;
            min-width: 300px;
        }
        
        .stat-card {
            background-color: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.06);
            border-left: 5px solid #4caf50;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
            border: 1px solid rgba(76, 175, 80, 0.1);
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(to right, #4caf50, transparent);
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border-color: rgba(76, 175, 80, 0.2);
        }
        
        .stat-title {
            font-size: 0.85rem;
            color: #5a7d5c;
            margin-bottom: 8px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: 800;
            color: #2d572c;
            line-height: 1.2;
        }
        
        .stat-sales {
            border-left: 5px solid #673ab7;
        }
        
        .stat-sales::before {
            background: linear-gradient(to right, #673ab7, transparent);
        }
        
        .stat-sales .stat-value {
            color: #673ab7;
        }
        
        .change-history {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px dashed #c8e6c9;
        }
        
        .history-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            font-size: 0.85rem;
        }
        
        .history-date {
            color: #666;
            font-weight: 500;
        }
        
        .empty-table {
            text-align: center;
            padding: 50px;
            color: #8a9c8b;
            font-style: italic;
            font-size: 1rem;
        }
        
        .empty-table i {
            font-size: 2.5rem;
            margin-bottom: 15px;
            color: #c8e6c9;
            display: block;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease;
            padding: 15px;
            overflow-y: auto;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            background-color: white;
            border-radius: 16px;
            width: 100%;
            max-width: 600px;
            padding: 25px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.25);
            animation: slideUp 0.4s ease;
            border: 1px solid rgba(76, 175, 80, 0.1);
            position: relative;
            overflow: hidden;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 6px;
            background: linear-gradient(to right, #4caf50, #2d572c);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 1.3rem;
            color: #2d572c;
            font-weight: 700;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #8a9c8b;
            transition: color 0.3s;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .close-modal:hover {
            color: #f44336;
            background-color: rgba(244, 67, 54, 0.05);
        }
        
        .tab-container {
            margin-top: 25px;
        }
        
        .tabs {
            display: flex;
            border-bottom: 2px solid #e0f2e0;
            overflow-x: auto;
            background-color: #f9fdf9;
            border-radius: 12px 12px 0 0;
            padding: 5px 5px 0 5px;
            -webkit-overflow-scrolling: touch;
        }
        
        .tab {
            padding: 14px 20px;
            background: none;
            border: none;
            font-size: 0.95rem;
            font-weight: 600;
            color: #6b8c6d;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            white-space: nowrap;
            position: relative;
            border-radius: 8px 8px 0 0;
            margin-right: 5px;
            flex-shrink: 0;
            min-height: 48px;
        }
        
        .tab::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 50%;
            width: 0;
            height: 3px;
            background: #4caf50;
            transition: all 0.3s;
            transform: translateX(-50%);
        }
        
        .tab.active {
            color: #2d572c;
            background-color: white;
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.03);
        }
        
        .tab.active::after {
            width: 100%;
        }
        
        .tab:hover:not(.active) {
            color: #4caf50;
            background-color: rgba(76, 175, 80, 0.05);
        }
        
        .tab-content {
            padding: 20px 0;
            display: none;
            animation: fadeInContent 0.5s ease;
        }
        
        @keyframes fadeInContent {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .tab-content.active {
            display: block;
        }
        
        .reminder-list {
            margin-top: 20px;
        }
        
        .reminder-item {
            padding: 16px;
            border-radius: 12px;
            background-color: #fff8e1;
            border-left: 5px solid #ff9800;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(255, 152, 0, 0.08);
            gap: 12px;
        }
        
        .reminder-item:hover {
            transform: translateX(3px);
            box-shadow: 0 6px 15px rgba(255, 152, 0, 0.15);
        }
        
        .reminder-item.danger {
            background-color: #ffebee;
            border-left-color: #f44336;
            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.08);
        }
        
        .reminder-item.danger:hover {
            box-shadow: 0 6px 15px rgba(244, 67, 54, 0.15);
        }
        
        .editable-cell {
            cursor: pointer;
            position: relative;
        }
        
        .editable-cell:hover {
            background-color: #e8f5e9 !important;
        }
        
        .edit-input {
            width: 100%;
            padding: 8px;
            border: 2px solid #4caf50;
            border-radius: 8px;
            font-size: 0.95rem;
            background-color: #f9fdf9;
            box-shadow: 0 3px 8px rgba(76, 175, 80, 0.1);
        }
        
        .edit-input:focus {
            outline: none;
        }
        
        .quick-edit-buttons {
            display: flex;
            gap: 5px;
            margin-top: 6px;
            flex-wrap: wrap;
        }
        
        .quick-btn {
            padding: 5px 10px;
            font-size: 0.75rem;
            border-radius: 6px;
            background-color: #e8f5e9;
            border: 1px solid #c8e6c9;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 30px;
        }
        
        .quick-btn:hover {
            background-color: #4caf50;
            color: white;
            border-color: #4caf50;
        }
        
        .no-change-needed {
            color: #8a9c8b;
            font-style: italic;
        }
        
        .gender-adult {
            font-weight: 700;
            color: #9c27b0;
        }
        
        .gender-larva {
            font-weight: 700;
            color: #4caf50;
        }
        
        .gender-pupa {
            font-weight: 700;
            color: #ff9800;
        }
        
        .history-preserved {
            font-size: 0.8rem;
            color: #5a7d5c;
            margin-top: 4px;
            font-style: italic;
        }
        
        .metamorphosis-info {
            display: inline-block;
            background: linear-gradient(135deg, #ff9800, #ff5722);
            color: white;
            padding: 2px 8px;
            border-radius: 15px;
            font-size: 0.7rem;
            margin-left: 6px;
            font-weight: 600;
            box-shadow: 0 2px 6px rgba(255, 152, 0, 0.3);
        }
        
        .larva-history-preserved {
            display: inline-block;
            background-color: #e8f5e9;
            color: #2d572c;
            padding: 2px 8px;
            border-radius: 15px;
            font-size: 0.7rem;
            margin-left: 6px;
            font-weight: 600;
            border: 1px solid #c8e6c9;
        }
        
        .soil-history-badge {
            display: inline-block;
            background: linear-gradient(135deg, #2196f3, #1976d2);
            color: white;
            padding: 2px 10px;
            border-radius: 15px;
            font-size: 0.7rem;
            margin-left: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 6px rgba(33, 150, 243, 0.2);
        }
        
        .soil-history-badge:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(33, 150, 243, 0.3);
        }
        
        .tooltip {
            position: relative;
            display: inline-block;
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 280px;
            background-color: #2d572c;
            color: #fff;
            text-align: left;
            border-radius: 10px;
            padding: 12px;
            position: absolute;
            z-index: 1001;
            bottom: 125%;
            left: 50%;
            margin-left: -140px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.8rem;
            font-weight: normal;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            border: 1px solid #4caf50;
        }
        
        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 8px;
            border-style: solid;
            border-color: #2d572c transparent transparent transparent;
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        
        .soil-history-tooltip {
            max-height: 180px;
            overflow-y: auto;
        }
        
        .soil-history-item {
            padding: 6px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .soil-history-item:last-child {
            border-bottom: none;
        }
        
        .sale-badge {
            display: inline-block;
            background-color: #e1bee7;
            color: #4a148c;
            padding: 2px 10px;
            border-radius: 15px;
            font-size: 0.7rem;
            margin-left: 6px;
            font-weight: 600;
            border: 1px solid #ce93d8;
        }
        
        .sale-item {
            padding: 16px;
            border-radius: 12px;
            background-color: #f3e5f5;
            border-left: 5px solid #673ab7;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            box-shadow: 0 4px 12px rgba(103, 58, 183, 0.08);
            transition: all 0.3s;
            gap: 12px;
        }
        
        .sale-item:hover {
            transform: translateX(3px);
            box-shadow: 0 6px 15px rgba(103, 58, 183, 0.15);
        }
        
        .sale-stat {
            display: inline-block;
            padding: 5px 12px;
            background-color: #673ab7;
            color: white;
            border-radius: 15px;
            font-size: 0.85rem;
            margin-left: 8px;
            font-weight: 600;
            box-shadow: 0 2px 6px rgba(103, 58, 183, 0.3);
        }
        
        .sale-stat.larva {
            background-color: #4caf50;
            box-shadow: 0 2px 6px rgba(76, 175, 80, 0.3);
        }
        
        .sale-stat.adult {
            background-color: #9c27b0;
            box-shadow: 0 2px 6px rgba(156, 39, 176, 0.3);
        }
        
        .sale-stat.total {
            background-color: #ff9800;
            box-shadow: 0 2px 6px rgba(255, 152, 0, 0.3);
        }
        
        .info-card {
            margin-top: 25px;
            padding: 20px;
            background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
            border-radius: 12px;
            border: 1px solid #a5d6a7;
        }
        
        .info-card h3 {
            color: #2d572c;
            margin-bottom: 12px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .info-card p {
            color: #3a5a3a;
            line-height: 1.6;
            font-size: 0.9rem;
        }
        
        .input-with-icon {
            position: relative;
        }
        
        .input-with-icon i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #8a9c8b;
            font-size: 0.9rem;
        }
        
        .input-with-icon input {
            padding-left: 40px;
        }
        
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 6px;
        }
        
        .badge-success {
            background-color: #e8f5e9;
            color: #2d572c;
            border: 1px solid #c8e6c9;
        }
        
        .badge-warning {
            background-color: #fff3e0;
            color: #e65100;
            border: 1px solid #ffcc80;
        }
        
        .badge-danger {
            background-color: #ffebee;
            color: #c62828;
            border: 1px solid #ef9a9a;
        }
        
        .category-total-row {
            background-color: #f1f8e9 !important;
            font-weight: bold;
            border-top: 2px solid #c8e6c9;
        }
        
        .category-total-row td {
            padding: 12px;
            border-bottom: 1px solid #c8e6c9;
        }
        
        .grand-total-row {
            background-color: #e8f5e9 !important;
            font-weight: bold;
            font-size: 0.95rem;
            border-top: 3px solid #4caf50;
            border-bottom: 3px solid #4caf50;
        }
        
        .grand-total-row td {
            padding: 14px 12px;
            color: #2d572c;
        }
        
        .error-message {
            color: #f44336;
            font-size: 0.85rem;
            margin-top: 5px;
            display: none;
        }
        
        .input-error {
            border-color: #f44336 !important;
        }
        
        .input-error:focus {
            box-shadow: 0 0 0 3px rgba(244, 67, 54, 0.15) !important;
        }
        
        .loading {
            position: relative;
            pointer-events: none;
            opacity: 0.7;
        }
        
        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #4caf50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            transform: translate(-50%, -50%);
        }
        
        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }
        
        .mobile-only {
            display: none;
        }
        
        .desktop-only {
            display: block;
        }
        
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #2d572c;
            color: white;
            padding: 12px 24px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 1001;
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            max-width: 90%;
            text-align: center;
        }
        
        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        
        .backup-notice {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #fff3e0;
            border: 1px solid #ffcc80;
            border-radius: 10px;
            padding: 12px 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 1002;
            max-width: 300px;
            display: none;
        }
        
        .backup-notice.show {
            display: block;
            animation: slideInRight 0.3s ease;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .search-container {
            margin-bottom: 20px;
        }
        
        .search-input {
            width: 100%;
            padding: 12px 15px 12px 45px;
            border: 2px solid #e0f2e0;
            border-radius: 10px;
            font-size: 1rem;
            background-color: #f9fdf9;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%238a9c8b' viewBox='0 0 16 16'%3E%3Cpath d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: 15px center;
            background-size: 16px;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #4caf50;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.15);
            background-color: white;
        }
        
        .no-results {
            text-align: center;
            padding: 40px;
            color: #8a9c8b;
            font-style: italic;
        }
        
        .no-results i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #e0f2e0;
            display: block;
        }
        
        /* 滚动条美化 */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f8e9;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #c8e6c9;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #a5d6a7;
        }
        
        /* 响应式设计 */
        @media (max-width: 1200px) {
            .form-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 992px) {
            .header {
                padding: 20px 25px;
            }
            
            .content {
                padding: 20px;
            }
            
            .section {
                padding: 20px;
                margin-bottom: 25px;
            }
            
            .stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                border-radius: 15px;
            }
            
            .header {
                padding: 15px 20px;
                flex-direction: column;
                gap: 15px;
            }
            
            .logo-container {
                width: 100%;
                justify-content: center;
                text-align: center;
            }
            
            .logo {
                width: 60px;
                height: 60px;
            }
            
            .logo i {
                font-size: 2rem;
            }
            
            .title {
                font-size: 1.5rem;
                text-align: center;
            }
            
            .brand {
                align-self: center;
                font-size: 0.9rem;
            }
            
            .content {
                padding: 15px;
            }
            
            .section {
                padding: 18px;
                margin-bottom: 20px;
            }
            
            .section-title {
                font-size: 1.2rem;
            }
            
            .section-title i {
                width: 36px;
                height: 36px;
                font-size: 0.9rem;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            input, select {
                padding: 14px 15px;
                font-size: 16px; /* 防止iOS缩放 */
            }
            
            .action-cell {
                flex-direction: column;
                align-items: stretch;
                gap: 6px;
            }
            
            .action-btn {
                width: 100%;
                justify-content: center;
                min-height: 40px;
            }
            
            .tooltip .tooltiptext {
                width: 250px;
                margin-left: -125px;
                font-size: 0.75rem;
                padding: 10px;
            }
            
            .tabs {
                padding: 3px 3px 0 3px;
            }
            
            .tab {
                padding: 12px 15px;
                font-size: 0.9rem;
                min-height: 44px;
            }
            
            .stats {
                grid-template-columns: 1fr;
                gap: 12px;
                width: 100%;
            }
            
            .stat-card {
                padding: 16px;
            }
            
            .stat-title {
                font-size: 0.8rem;
            }
            
            .stat-value {
                font-size: 1.5rem;
            }
            
            .button-group {
                justify-content: center;
            }
            
            button {
                padding: 14px 20px;
                flex: 1;
                min-width: 140px;
                min-height: 48px;
                font-size: 0.9rem;
            }
            
            .modal-content {
                padding: 20px 15px;
                width: 100%;
                max-height: 85vh;
                border-radius: 12px;
            }
            
            .modal-title {
                font-size: 1.2rem;
            }
            
            .info-card {
                padding: 15px;
            }
            
            .info-card h3 {
                font-size: 1rem;
            }
            
            .info-card p {
                font-size: 0.85rem;
            }
            
            .mobile-only {
                display: block;
            }
            
            .desktop-only {
                display: none;
            }
            
            .backup-notice {
                top: 10px;
                right: 10px;
                left: 10px;
                max-width: 100%;
            }
        }
        
        @media (max-width: 480px) {
            .header {
                padding: 12px 15px;
            }
            
            .title {
                font-size: 1.3rem;
            }
            
            .brand {
                font-size: 0.8rem;
                padding: 4px 10px;
            }
            
            .content {
                padding: 12px;
            }
            
            .section {
                padding: 15px;
            }
            
            button {
                min-width: 120px;
                padding: 12px 16px;
            }
            
            .action-btn {
                padding: 10px;
            }
            
            th, td {
                padding: 10px 8px;
                font-size: 0.85rem;
            }
            
            .tab {
                padding: 10px 12px;
                font-size: 0.85rem;
            }
            
            .stat-card {
                padding: 14px;
            }
            
            .stat-value {
                font-size: 1.3rem;
            }
            
            .toast {
                bottom: 10px;
                padding: 10px 16px;
                font-size: 0.9rem;
            }
        }
        
        @media (hover: none) {
            button:hover {
                transform: none !important;
            }
            
            .stat-card:hover {
                transform: none !important;
            }
            
            .reminder-item:hover {
                transform: none !important;
            }
            
            .sale-item:hover {
                transform: none !important;
            }
            
            .soil-history-badge:hover {
                transform: none !important;
            }
            
            .logo:hover {
                transform: none !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="logo-container">
                <div class="logo">
                    <i class="fas fa-bug"></i>
                </div>
                <div class="title-area">
                    <h1 class="title">甲虫库存管理工具</h1>
                    <div class="brand">wenbin出品 · 专业甲虫养殖管理</div>
                </div>
            </div>
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-title"><i class="fas fa-bug"></i> 总库存数量</div>
                    <div class="stat-value" id="total-count">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title"><i class="fas fa-yen-sign"></i> 总价值</div>
                    <div class="stat-value" id="total-value">¥0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title"><i class="fas fa-seedling"></i> 近期需换土</div>
                    <div class="stat-value" id="need-change">0</div>
                </div>
                <div class="stat-card stat-sales">
                    <div class="stat-title"><i class="fas fa-money-bill-wave"></i> 总销售金额</div>
                    <div class="stat-value" id="total-sales">¥0</div>
                </div>
            </div>
        </header>
        
        <div class="content">
            <!-- 数据备份提醒 -->
            <div class="backup-notice" id="backup-notice">
                <p style="margin-bottom: 8px; font-weight: 600; color: #e65100;"><i class="fas fa-exclamation-triangle"></i> 重要提醒</p>
                <p style="font-size: 0.9rem; margin-bottom: 10px;">数据仅保存在浏览器本地，请定期备份以防丢失！</p>
                <button id="backup-now" class="btn-warning" style="width: 100%; padding: 8px;">
                    <i class="fas fa-save"></i> 立即备份
                </button>
            </div>
            
            <div class="tab-container">
                <div class="tabs">
                    <button class="tab active" data-tab="inventory">
                        <i class="fas fa-boxes"></i> <span class="desktop-only">库存管理</span><span class="mobile-only">库存</span>
                    </button>
                    <button class="tab" data-tab="sales">
                        <i class="fas fa-chart-line"></i> <span class="desktop-only">售卖记录</span><span class="mobile-only">销售</span>
                    </button>
                    <button class="tab" data-tab="reminders">
                        <i class="fas fa-bell"></i> <span class="desktop-only">换土提醒</span><span class="mobile-only">提醒</span>
                    </button>
                    <button class="tab" data-tab="data">
                        <i class="fas fa-database"></i> <span class="desktop-only">数据管理</span><span class="mobile-only">数据</span>
                    </button>
                </div>
                
                <!-- 库存管理标签 -->
                <div class="tab-content active" id="inventory-tab">
                    <section class="section">
                        <h2 class="section-title"><i class="fas fa-plus-circle"></i> 新增库存项目</h2>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="item-name"><i class="fas fa-tag"></i> 品名 *</label>
                                <input type="text" id="item-name" placeholder="输入品名，如：彩虹锹形虫">
                                <div class="input-hint">输入新品名将自动添加到下拉选单</div>
                                <div class="error-message" id="name-error">请输入品名</div>
                            </div>
                            
                            <div class="form-group">
                                <label for="item-subcategory"><i class="fas fa-filter"></i> 子分类</label>
                                <input type="text" id="item-subcategory" placeholder="例如：红色型、蓝色型、特殊色">
                                <div class="input-hint">同一品名下的不同颜色或分类</div>
                            </div>
                            
                            <div class="form-group">
                                <label for="item-size"><i class="fas fa-ruler"></i> 尺寸 (mm)</label>
                                <input type="text" id="item-size" placeholder="例如：70-85 或 L1/L2/L3">
                            </div>
                            
                            <div class="form-group">
                                <label for="item-gender"><i class="fas fa-venus-mars"></i> 性别/阶段 *</label>
                                <select id="item-gender">
                                    <option value="">选择性别/阶段</option>
                                    <option value="公">公</option>
                                    <option value="母">母</option>
                                    <option value="幼虫">幼虫</option>
                                    <option value="蛹">蛹</option>
                                    <option value="未知">未知</option>
                                </select>
                                <div class="error-message" id="gender-error">请选择性别/阶段</div>
                            </div>
                            
                            <div class="form-group">
                                <label for="item-quantity"><i class="fas fa-hashtag"></i> 数量 *</label>
                                <input type="number" id="item-quantity" min="1" value="1">
                                <div class="error-message" id="quantity-error">数量必须大于0</div>
                            </div>
                            
                            <div class="form-group">
                                <label for="item-price"><i class="fas fa-yen-sign"></i> 单价 (¥)</label>
                                <input type="number" id="item-price" min="0" step="0.01" placeholder="例如：150.00">
                                <div class="error-message" id="price-error">单价不能为负数</div>
                            </div>
                            
                            <div class="form-group">
                                <label for="item-change-date"><i class="fas fa-calendar-day"></i> 最近换土时间</label>
                                <input type="date" id="item-change-date">
                                <div class="input-hint">仅幼虫/蛹需要，成虫不需填写</div>
                            </div>
                            
                            <div class="form-group">
                                <label for="item-next-change-date"><i class="fas fa-calendar-week"></i> 下次换土时间</label>
                                <input type="date" id="item-next-change-date" readonly>
                                <div class="input-hint">系统自动计算（三个月后）</div>
                            </div>
                        </div>
                        
                        <div class="button-group">
                            <button id="add-item" class="btn-primary">
                                <i class="fas fa-plus"></i> 新增项目
                            </button>
                            <button id="clear-form" class="btn-secondary">
                                <i class="fas fa-eraser"></i> 清空表单
                            </button>
                            <button id="auto-fill-date" class="btn-info">
                                <i class="fas fa-calendar-alt"></i> 自动填充换土时间
                            </button>
                        </div>
                    </section>
                    
                    <section class="section">
                        <h2 class="section-title"><i class="fas fa-list"></i> 库存列表</h2>
                        
                        <!-- 搜索功能 -->
                        <div class="search-container">
                            <input type="text" class="search-input" id="search-inventory" placeholder="搜索品名、子分类或尺寸...">
                        </div>
                        
                        <div class="info-card">
                            <h3><i class="fas fa-info-circle"></i> 使用提示</h3>
                            <p><i class="fas fa-bug"></i> <strong>幼虫羽化功能</strong>：对于幼虫项目，点击"羽化"按钮可以将其中一只分离为成虫，原幼虫数量减1，成虫将保留幼虫时期的换土历史记录。</p>
                            <p><i class="fas fa-money-bill-wave"></i> <strong>售卖功能</strong>：点击"售卖"按钮可以记录销售，销售记录会单独统计。</p>
                            <p><i class="fas fa-edit"></i> <strong>快速编辑</strong>：点击数量或单价单元格可以直接编辑数值。</p>
                            <p><i class="fas fa-chart-bar"></i> <strong>类别统计</strong>：表格中每个品名下方都会显示该品名的总数量和总价值，表格底部显示所有库存的总计。</p>
                        </div>
                        
                        <div class="table-container">
                            <table id="inventory-table">
                                <thead>
                                    <tr>
                                        <th>品名</th>
                                        <th>子分类</th>
                                        <th>尺寸</th>
                                        <th>性别/阶段</th>
                                        <th>数量</th>
                                        <th>单价</th>
                                        <th>总价</th>
                                        <th class="desktop-only">最近换土时间</th>
                                        <th class="desktop-only">下次换土时间</th>
                                        <th>状态</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="inventory-body">
                                    <!-- 库存数据将通过JavaScript动态添加 -->
                                </tbody>
                            </table>
                            <div id="empty-table-message" class="empty-table">
                                <i class="fas fa-inbox"></i>
                                暂无库存数据，请添加新的甲虫项目
                            </div>
                            <div id="no-results-message" class="no-results" style="display: none;">
                                <i class="fas fa-search"></i>
                                没有找到匹配的项目
                            </div>
                        </div>
                    </section>
                </div>
                
                <!-- 售卖记录标签 -->
                <div class="tab-content" id="sales-tab">
                    <section class="section">
                        <h2 class="section-title"><i class="fas fa-money-bill-wave"></i> 售卖记录</h2>
                        
                        <div class="info-card" style="background: linear-gradient(135deg, #f3e5f5, #e1bee7); border-color: #ce93d8;">
                            <h3><i class="fas fa-chart-line"></i> 销售统计</h3>
                            <div style="display: flex; flex-wrap: wrap; gap: 15px; align-items: center;">
                                <div>
                                    <span style="font-weight: 600;">总销售数量：</span>
                                    <span class="sale-stat total" id="sales-total-count">0</span>
                                </div>
                                <div>
                                    <span style="font-weight: 600;">幼虫销售：</span>
                                    <span class="sale-stat larva" id="sales-larva-count">0</span>
                                </div>
                                <div>
                                    <span style="font-weight: 600;">成虫销售：</span>
                                    <span class="sale-stat adult" id="sales-adult-count">0</span>
                                </div>
                                <div>
                                    <span style="font-weight: 600;">总销售金额：</span>
                                    <span style="color: #673ab7; font-weight: 800; font-size: 1.2rem;" id="sales-total-amount">¥0</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 销售搜索 -->
                        <div class="search-container">
                            <input type="text" class="search-input" id="search-sales" placeholder="搜索销售记录...">
                        </div>
                        
                        <div class="table-container">
                            <table id="sales-table">
                                <thead>
                                    <tr>
                                        <th>售出日期</th>
                                        <th>品名</th>
                                        <th class="desktop-only">子分类</th>
                                        <th class="desktop-only">尺寸</th>
                                        <th>性别/阶段</th>
                                        <th>数量</th>
                                        <th>单价</th>
                                        <th>总价</th>
                                        <th class="desktop-only">备注</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="sales-body">
                                    <!-- 售卖数据将通过JavaScript动态添加 -->
                                </tbody>
                            </table>
                            <div id="empty-sales-message" class="empty-table">
                                <i class="fas fa-chart-bar"></i>
                                暂无售卖记录
                            </div>
                            <div id="no-sales-results-message" class="no-results" style="display: none;">
                                <i class="fas fa-search"></i>
                                没有找到匹配的销售记录
                            </div>
                        </div>
                        
                        <div class="button-group" style="margin-top: 25px;">
                            <button id="clear-sales" class="btn-danger">
                                <i class="fas fa-trash-alt"></i> 清空售卖记录
                            </button>
                            <button id="export-sales-excel" class="btn-warning">
                                <i class="fas fa-file-excel"></i> 导出销售记录
                            </button>
                        </div>
                    </section>
                </div>
                
                <!-- 换土提醒标签 -->
                <div class="tab-content" id="reminders-tab">
                    <section class="section">
                        <h2 class="section-title"><i class="fas fa-bell"></i> 换土提醒</h2>
                        <p style="margin-bottom: 20px; color: #3a5a3a; font-size: 0.95rem;">以下甲虫项目需要关注换土时间，建议在下次换土时间前进行操作。<strong>注：成虫（公、母）不需要换土，但保留历史记录。</strong></p>
                        
                        <div class="reminder-list" id="reminder-list">
                            <!-- 换土提醒将动态生成 -->
                        </div>
                        
                        <div class="info-card">
                            <h3><i class="fas fa-info-circle"></i> 换土提示</h3>
                            <p><strong>成虫（公、母）</strong>不需要换土，只需定期清洁和喂食，但会保留幼虫时期的换土历史记录。</p>
                            <p><strong>幼虫</strong>通常建议每1-3个月换土一次，具体时间根据甲虫种类和生长阶段调整。</p>
                            <p><strong>蛹</strong>在化蛹期间不需要换土，但需要保持适当的湿度。</p>
                            <p>点击库存列表中的"记录换土"按钮可以更新换土时间，系统会自动计算下一次换土时间（默认3个月后）。</p>
                        </div>
                    </section>
                </div>
                
                <!-- 数据管理标签 -->
                <div class="tab-content" id="data-tab">
                    <section class="section">
                        <h2 class="section-title"><i class="fas fa-database"></i> 数据管理</h2>
                        <div class="info-card">
                            <h3><i class="fas fa-download"></i> 数据备份与恢复</h3>
                            <p>数据默认保存在浏览器本地存储中。如需备份，请使用导出功能将数据保存到文件。定期备份可以防止数据丢失。</p>
                            <p style="margin-top: 10px; color: #e65100; font-weight: 600;"><i class="fas fa-exclamation-triangle"></i> 重要：更换浏览器或清除缓存会导致数据丢失！</p>
                        </div>
                        <div class="data-actions">
                            <button id="save-local" class="btn-primary">
                                <i class="fas fa-save"></i> <span class="desktop-only">保存到本地存储</span><span class="mobile-only">保存</span>
                            </button>
                            <button id="load-local" class="btn-secondary">
                                <i class="fas fa-folder-open"></i> <span class="desktop-only">从本地存储加载</span><span class="mobile-only">加载</span>
                            </button>
                            <button id="export-json" class="btn-secondary">
                                <i class="fas fa-file-export"></i> <span class="desktop-only">导出为JSON文件</span><span class="mobile-only">导出JSON</span>
                            </button>
                            <button id="import-json" class="btn-secondary">
                                <i class="fas fa-file-import"></i> <span class="desktop-only">导入JSON文件</span><span class="mobile-only">导入JSON</span>
                            </button>
                            <button id="export-excel" class="btn-warning">
                                <i class="fas fa-file-excel"></i> <span class="desktop-only">导出为Excel</span><span class="mobile-only">导出Excel</span>
                            </button>
                            <button id="clear-data" class="btn-danger">
                                <i class="fas fa-trash-alt"></i> <span class="desktop-only">清空所有数据</span><span class="mobile-only">清空数据</span>
                            </button>
                        </div>
                        
                        <!-- 数据统计 -->
                        <div class="info-card" style="margin-top: 25px;">
                            <h3><i class="fas fa-chart-pie"></i> 数据统计</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 15px;">
                                <div>
                                    <div style="font-weight: 600; color: #5a7d5c; font-size: 0.9rem;">库存项目数</div>
                                    <div style="font-size: 1.5rem; font-weight: 800; color: #2d572c;" id="data-item-count">0</div>
                                </div>
                                <div>
                                    <div style="font-weight: 600; color: #5a7d5c; font-size: 0.9rem;">销售记录数</div>
                                    <div style="font-size: 1.5rem; font-weight: 800; color: #673ab7;" id="data-sales-count">0</div>
                                </div>
                                <div>
                                    <div style="font-weight: 600; color: #5a7d5c; font-size: 0.9rem;">最后备份</div>
                                    <div style="font-size: 0.9rem; color: #8a9c8b;" id="last-backup">从未备份</div>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>
            </div>
        </div>
        
        <footer class="footer">
            <p>甲虫库存管理工具 &copy; <span id="current-year">2023</span> | wenbin出品</p>
            <p style="margin-top: 8px; font-size: 0.85rem; color: #8a9c8b;">
                <i class="fas fa-lock"></i> 本工具支持本地存储，数据不会上传到服务器
            </p>
        </footer>
    </div>

    <!-- 记录换土模态框 -->
    <div id="change-soil-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-seedling"></i> 记录换土</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div>
                <p id="modal-item-name" style="margin-bottom: 20px; font-weight: 600; font-size: 1rem; color: #2d572c;"></p>
                <div class="form-group">
                    <label for="soil-change-date"><i class="fas fa-calendar-day"></i> 换土日期</label>
                    <input type="date" id="soil-change-date">
                    <div class="error-message" id="soil-date-error">请选择换土日期</div>
                </div>
                <div class="form-group" style="margin-top: 15px;">
                    <label for="soil-notes"><i class="fas fa-sticky-note"></i> 备注 (可选)</label>
                    <input type="text" id="soil-notes" placeholder="例如：更换新土，添加发酵木屑">
                </div>
                <div class="button-group" style="margin-top: 25px;">
                    <button id="save-soil-change" class="btn-primary">
                        <i class="fas fa-save"></i> 保存换土记录
                    </button>
                    <button id="cancel-soil-change" class="btn-secondary">
                        取消
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 查看换土历史模态框 -->
    <div id="history-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-history"></i> 换土历史记录</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div>
                <p id="history-item-name" style="margin-bottom: 20px; font-weight: 600; font-size: 1rem; color: #2d572c;"></p>
                <div id="history-list">
                    <!-- 换土历史将动态生成 -->
                </div>
                <div class="button-group" style="margin-top: 25px;">
                    <button id="close-history" class="btn-secondary">
                        关闭
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 编辑项目模态框 -->
    <div id="edit-item-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-edit"></i> 编辑项目</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="edit-item-name"><i class="fas fa-tag"></i> 品名 *</label>
                        <input type="text" id="edit-item-name">
                        <div class="error-message" id="edit-name-error">请输入品名</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-item-subcategory"><i class="fas fa-filter"></i> 子分类</label>
                        <input type="text" id="edit-item-subcategory">
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-item-size"><i class="fas fa-ruler"></i> 尺寸 (mm)</label>
                        <input type="text" id="edit-item-size">
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-item-gender"><i class="fas fa-venus-mars"></i> 性别/阶段 *</label>
                        <select id="edit-item-gender">
                            <option value="">选择性别/阶段</option>
                            <option value="公">公</option>
                            <option value="母">母</option>
                            <option value="幼虫">幼虫</option>
                            <option value="蛹">蛹</option>
                            <option value="未知">未知</option>
                        </select>
                        <div class="error-message" id="edit-gender-error">请选择性别/阶段</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-item-quantity"><i class="fas fa-hashtag"></i> 数量 *</label>
                        <input type="number" id="edit-item-quantity" min="1" value="1">
                        <div class="error-message" id="edit-quantity-error">数量必须大于0</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-item-price"><i class="fas fa-yen-sign"></i> 单价 (¥)</label>
                        <input type="number" id="edit-item-price" min="0" step="0.01">
                        <div class="error-message" id="edit-price-error">单价不能为负数</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-item-last-change"><i class="fas fa-calendar-day"></i> 最近换土时间</label>
                        <input type="date" id="edit-item-last-change">
                        <div class="input-hint">仅幼虫/蛹需要，成虫不需填写</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-item-next-change"><i class="fas fa-calendar-week"></i> 下次换土时间</label>
                        <input type="date" id="edit-item-next-change">
                        <div class="input-hint">仅幼虫/蛹需要，成虫不需填写</div>
                    </div>
                </div>
                
                <div id="edit-history-info" style="margin-top: 15px; padding: 12px; background-color: #e8f5e9; border-radius: 8px; display: none; border: 1px solid #c8e6c9;">
                    <p style="font-size: 0.9rem; color: #2d572c;">
                        <i class="fas fa-info-circle"></i> 此项目有 <span id="edit-history-count">0</span> 条换土历史记录，改变性别不会删除这些记录。
                    </p>
                </div>
                
                <div class="button-group" style="margin-top: 25px;">
                    <button id="save-item-edit" class="btn-primary">
                        <i class="fas fa-save"></i> 保存修改
                    </button>
                    <button id="cancel-item-edit" class="btn-secondary">
                        取消
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 幼虫羽化模态框 -->
    <div id="metamorphosis-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-bug"></i> 幼虫羽化记录</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div>
                <p id="metamorphosis-item-name" style="margin-bottom: 20px; font-weight: 600; font-size: 1rem; color: #2d572c;"></p>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="metamorphosis-gender"><i class="fas fa-venus-mars"></i> 羽化后性别 *</label>
                        <select id="metamorphosis-gender">
                            <option value="">选择性别</option>
                            <option value="公">公</option>
                            <option value="母">母</option>
                        </select>
                        <div class="error-message" id="metamorphosis-gender-error">请选择羽化后性别</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="metamorphosis-size"><i class="fas fa-ruler"></i> 成虫尺寸 (mm)</label>
                        <input type="text" id="metamorphosis-size" placeholder="例如：70-85">
                    </div>
                    
                    <div class="form-group">
                        <label for="metamorphosis-price"><i class="fas fa-yen-sign"></i> 成虫单价 (¥)</label>
                        <input type="number" id="metamorphosis-price" min="0" step="0.01" placeholder="留空则使用幼虫单价">
                        <div class="error-message" id="metamorphosis-price-error">单价不能为负数</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="metamorphosis-date"><i class="fas fa-calendar-day"></i> 羽化日期 *</label>
                        <input type="date" id="metamorphosis-date">
                        <div class="error-message" id="metamorphosis-date-error">请选择羽化日期</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="metamorphosis-notes"><i class="fas fa-sticky-note"></i> 备注 (可选)</label>
                        <input type="text" id="metamorphosis-notes" placeholder="例如：成功羽化，体型较大">
                    </div>
                </div>
                
                <div id="metamorphosis-info" style="margin-top: 15px; padding: 12px; background-color: #e8f5e9; border-radius: 8px; border: 1px solid #c8e6c9;">
                    <p style="font-size: 0.9rem; color: #2d572c;">
                        <i class="fas fa-info-circle"></i> 此幼虫有 <span id="metamorphosis-history-count">0</span> 条换土历史记录，羽化后将保留这些记录。
                    </p>
                </div>
                
                <div id="metamorphosis-warning" style="margin-top: 15px; padding: 12px; background-color: #fff3e0; border-radius: 8px; border: 1px solid #ffcc80;">
                    <p style="font-size: 0.9rem; color: #e65100;">
                        <i class="fas fa-exclamation-triangle"></i> 执行此操作后，原幼虫项目数量将减1，并创建一个新的成虫项目。
                    </p>
                </div>
                
                <div class="button-group" style="margin-top: 25px;">
                    <button id="save-metamorphosis" class="btn-metamorphosis">
                        <i class="fas fa-bug"></i> 确认羽化
                    </button>
                    <button id="cancel-metamorphosis" class="btn-secondary">
                        取消
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 售卖模态框 -->
    <div id="sale-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-money-bill-wave"></i> 记录售卖</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div>
                <p id="sale-item-name" style="margin-bottom: 20px; font-weight: 600; font-size: 1rem; color: #2d572c;"></p>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="sale-date"><i class="fas fa-calendar-day"></i> 售出日期 *</label>
                        <input type="date" id="sale-date">
                        <div class="error-message" id="sale-date-error">请选择售出日期</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="sale-quantity"><i class="fas fa-hashtag"></i> 售出数量 *</label>
                        <input type="number" id="sale-quantity" min="1" value="1">
                        <div class="input-hint">库存数量: <span id="sale-available-quantity">0</span></div>
                        <div class="error-message" id="sale-quantity-error">售出数量必须大于0且不超过库存数量</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="sale-price"><i class="fas fa-yen-sign"></i> 售出单价 (¥) *</label>
                        <input type="number" id="sale-price" min="0" step="0.01" placeholder="例如：150.00">
                        <div class="input-hint">原价: <span id="sale-original-price">¥0</span></div>
                        <div class="error-message" id="sale-price-error">售出单价必须大于0</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="sale-total-price"><i class="fas fa-calculator"></i> 售出总价 (¥)</label>
                        <input type="number" id="sale-total-price" min="0" step="0.01" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label for="sale-notes"><i class="fas fa-sticky-note"></i> 备注 (可选)</label>
                        <input type="text" id="sale-notes" placeholder="例如：售给王先生，快递发货">
                    </div>
                </div>
                
                <div id="sale-warning" style="margin-top: 15px; padding: 12px; background-color: #fff3e0; border-radius: 8px; border: 1px solid #ffcc80;">
                    <p style="font-size: 0.9rem; color: #e65100;">
                        <i class="fas fa-exclamation-triangle"></i> 执行此操作后，库存数量将相应减少。如果售出数量等于库存数量，该项目将从库存中移除。
                    </p>
                </div>
                
                <div class="button-group" style="margin-top: 25px;">
                    <button id="save-sale" class="btn-sale">
                        <i class="fas fa-money-bill-wave"></i> 确认售卖
                    </button>
                    <button id="cancel-sale" class="btn-secondary">
                        取消
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast通知 -->
    <div id="toast" class="toast"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // 优化后的JavaScript代码
        document.addEventListener('DOMContentLoaded', function() {
            // 设置当前年份
            document.getElementById('current-year').textContent = new Date().getFullYear();
            
            // 显示备份提醒
            setTimeout(() => {
                const lastBackup = localStorage.getItem('beetle-last-backup');
                if (!lastBackup) {
                    document.getElementById('backup-notice').classList.add('show');
                }
            }, 2000);
            
            // 初始化数据
            let inventory = JSON.parse(localStorage.getItem('beetle-inventory')) || [];
            let sales = JSON.parse(localStorage.getItem('beetle-sales')) || [];
            let itemNames = JSON.parse(localStorage.getItem('beetle-item-names')) || [];
            let subcategories = JSON.parse(localStorage.getItem('beetle-subcategories')) || {};
            
            // 更新数据统计
            function updateDataStats() {
                document.getElementById('data-item-count').textContent = inventory.length;
                document.getElementById('data-sales-count').textContent = sales.length;
                
                const lastBackup = localStorage.getItem('beetle-last-backup');
                if (lastBackup) {
                    const date = new Date(lastBackup);
                    document.getElementById('last-backup').textContent = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                }
            }
            
            // 显示Toast通知
            function showToast(message, type = 'success') {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.style.backgroundColor = type === 'success' ? '#2d572c' : type === 'error' ? '#f44336' : '#ff9800';
                toast.classList.add('show');
                
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            }
            
            // 标签切换功能
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    // 移除所有标签的active类
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    // 为当前标签添加active类
                    this.classList.add('active');
                    
                    // 显示对应的内容
                    const tabId = this.getAttribute('data-tab');
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                    
                    // 如果是提醒标签，刷新提醒列表
                    if (tabId === 'reminders') {
                        updateReminders();
                    }
                    
                    // 如果是销售标签，刷新销售记录
                    if (tabId === 'sales') {
                        renderSalesTable();
                        updateSalesStats();
                    }
                    
                    // 如果是数据标签，更新数据统计
                    if (tabId === 'data') {
                        updateDataStats();
                    }
                });
            });
            
            // 检查是否需要换土
            function needsSoilChange(gender) {
                // 成虫（公、母）不需要换土，幼虫、蛹、未知需要
                return gender !== '公' && gender !== '母';
            }
            
            // 获取性别对应的CSS类
            function getGenderClass(gender) {
                if (gender === '公' || gender === '母') {
                    return 'gender-adult';
                } else if (gender === '幼虫') {
                    return 'gender-larva';
                } else if (gender === '蛹') {
                    return 'gender-pupa';
                }
                return '';
            }
            
            // 更新统计数据
            function updateStats() {
                let totalCount = 0;
                let totalValue = 0;
                let needChangeCount = 0;
                let larvaPupaCount = 0;
                const today = new Date();
                const nextWeek = new Date();
                nextWeek.setDate(today.getDate() + 7);
                
                inventory.forEach(item => {
                    totalCount += item.quantity;
                    totalValue += item.quantity * item.price;
                    
                    // 统计幼虫/蛹数量
                    if (needsSoilChange(item.gender)) {
                        larvaPupaCount += item.quantity;
                    }
                    
                    // 检查是否需要换土
                    if (needsSoilChange(item.gender) && item.nextChangeDate) {
                        const nextChangeDate = new Date(item.nextChangeDate);
                        if (nextChangeDate <= nextWeek) {
                            needChangeCount++;
                        }
                    }
                });
                
                document.getElementById('total-count').textContent = totalCount;
                document.getElementById('total-value').textContent = '¥' + totalValue.toFixed(2);
                document.getElementById('need-change').textContent = needChangeCount;
                
                // 更新销售统计
                updateSalesStats();
                // 更新数据统计
                updateDataStats();
            }
            
            // 更新销售统计
            function updateSalesStats() {
                let totalSalesAmount = 0;
                let totalSalesCount = 0;
                let larvaSalesCount = 0;
                let adultSalesCount = 0;
                
                sales.forEach(sale => {
                    totalSalesAmount += sale.totalPrice;
                    totalSalesCount += sale.quantity;
                    
                    if (sale.gender === '幼虫') {
                        larvaSalesCount += sale.quantity;
                    } else if (sale.gender === '公' || sale.gender === '母') {
                        adultSalesCount += sale.quantity;
                    }
                });
                
                document.getElementById('total-sales').textContent = '¥' + totalSalesAmount.toFixed(2);
                document.getElementById('sales-total-count').textContent = totalSalesCount;
                document.getElementById('sales-larva-count').textContent = larvaSalesCount;
                document.getElementById('sales-adult-count').textContent = adultSalesCount;
                document.getElementById('sales-total-amount').textContent = '¥' + totalSalesAmount.toFixed(2);
            }
            
            // 更新子分类列表
            function updateSubcategories(name, subcategory) {
                if (!subcategory) return;
                
                if (!subcategories[name]) {
                    subcategories[name] = [];
                }
                
                if (!subcategories[name].includes(subcategory)) {
                    subcategories[name].push(subcategory);
                    localStorage.setItem('beetle-subcategories', JSON.stringify(subcategories));
                }
            }
            
            // 显示库存表格
            function renderInventoryTable(searchTerm = '') {
                const tbody = document.getElementById('inventory-body');
                const emptyMsg = document.getElementById('empty-table-message');
                const noResultsMsg = document.getElementById('no-results-message');
                
                // 过滤数据
                let filteredInventory = inventory;
                if (searchTerm) {
                    const term = searchTerm.toLowerCase();
                    filteredInventory = inventory.filter(item => 
                        item.name.toLowerCase().includes(term) ||
                        (item.subcategory && item.subcategory.toLowerCase().includes(term)) ||
                        (item.size && item.size.toLowerCase().includes(term))
                    );
                }
                
                if (filteredInventory.length === 0) {
                    tbody.innerHTML = '';
                    if (searchTerm && inventory.length > 0) {
                        emptyMsg.style.display = 'none';
                        noResultsMsg.style.display = 'block';
                    } else {
                        emptyMsg.style.display = 'block';
                        noResultsMsg.style.display = 'none';
                    }
                    updateStats();
                    return;
                }
                
                emptyMsg.style.display = 'none';
                noResultsMsg.style.display = 'none';
                
                // 按品名分组并排序
                const groupedItems = {};
                filteredInventory.forEach(item => {
                    if (!groupedItems[item.name]) {
                        groupedItems[item.name] = [];
                    }
                    groupedItems[item.name].push(item);
                });
                
                // 按品名排序
                const sortedNames = Object.keys(groupedItems).sort();
                
                let tableHTML = '';
                let grandTotalQuantity = 0;
                let grandTotalValue = 0;
                
                sortedNames.forEach(name => {
                    // 计算当前品名的总量和总价值
                    let categoryTotalQuantity = 0;
                    let categoryTotalValue = 0;
                    
                    // 添加品名分组标题行
                    tableHTML += `<tr class="group-header">
                        <td colspan="11">${name}</td>
                    </tr>`;
                    
                    // 按子分类进一步分组
                    const subGroupedItems = {};
                    groupedItems[name].forEach(item => {
                        const subKey = item.subcategory || '(无子分类)';
                        if (!subGroupedItems[subKey]) {
                            subGroupedItems[subKey] = [];
                        }
                        subGroupedItems[subKey].push(item);
                    });
                    
                    // 按子分类排序
                    const sortedSubcategories = Object.keys(subGroupedItems).sort();
                    
                    sortedSubcategories.forEach(subcategory => {
                        // 添加子分类标题行（如果有子分类）
                        if (subcategory !== '(无子分类)') {
                            tableHTML += `<tr class="subgroup-header">
                                <td></td>
                                <td colspan="10">${subcategory}</td>
                            </tr>`;
                        }
                        
                        // 添加该子分类下的所有项目
                        subGroupedItems[subcategory].forEach((item, index) => {
                            const totalPrice = item.quantity * item.price;
                            const genderClass = getGenderClass(item.gender);
                            const needsChange = needsSoilChange(item.gender);
                            
                            // 累加当前品名的总量和总价值
                            categoryTotalQuantity += item.quantity;
                            categoryTotalValue += totalPrice;
                            
                            // 累加总计
                            grandTotalQuantity += item.quantity;
                            grandTotalValue += totalPrice;
                            
                            // 对于成虫，不需要显示换土信息
                            let lastChangeDate = item.lastChangeDate || '未记录';
                            let nextChangeDate = item.nextChangeDate || '';
                            let statusHTML = '';
                            let statusText = '';
                            let historyNote = '';
                            
                            // 换土历史记录徽章
                            let soilHistoryBadge = '';
                            if (item.changeHistory && item.changeHistory.length > 0) {
                                const larvaHistoryCount = item.changeHistory.filter(record => 
                                    !record.notes || !record.notes.includes('羽化记录')
                                ).length;
                                
                                if (larvaHistoryCount > 0) {
                                    let tooltipContent = '';
                                    // 获取最近5条换土记录
                                    const recentHistory = item.changeHistory.slice(-5).reverse();
                                    recentHistory.forEach(record => {
                                        const historyDate = new Date(record.date).toLocaleDateString();
                                        tooltipContent += `<div class="soil-history-item">
                                            <div><strong>${historyDate}</strong></div>
                                            <div>${record.notes || '换土记录'}</div>
                                        </div>`;
                                    });
                                    
                                    soilHistoryBadge = `<span class="tooltip soil-history-badge" title="查看换土历史">
                                        换土历史
                                        <span class="tooltiptext soil-history-tooltip">${tooltipContent}</span>
                                    </span>`;
                                }
                            }
                            
                            // 检查是否为羽化生成的成虫
                            let metamorphosisNote = '';
                            if (item.metamorphosisFrom) {
                                metamorphosisNote = `<span class="metamorphosis-info">羽化</span>`;
                                
                                // 如果是羽化生成的成虫，且保留了幼虫换土记录
                                if (item.larvaHistoryPreserved && item.changeHistory && item.changeHistory.length > 0) {
                                    // 查找幼虫时期的换土记录数量
                                    const larvaHistoryCount = item.changeHistory.filter(record => 
                                        !record.notes || !record.notes.includes('羽化记录')
                                    ).length;
                                    
                                    if (larvaHistoryCount > 0) {
                                        historyNote = `<div class="history-preserved">保留幼虫时期${larvaHistoryCount}条换土记录</div>`;
                                    }
                                }
                            } else if (!needsChange && item.changeHistory && item.changeHistory.length > 0) {
                                // 非羽化生成的成虫，但有换土历史记录
                                historyNote = `<div class="history-preserved">保留${item.changeHistory.length}条换土记录</div>`;
                            }
                            
                            if (!needsChange) {
                                // 成虫 - 不计算换土时间，但保留历史记录
                                statusHTML = `<span class="status-indicator status-adult"></span>`;
                                statusText = '成虫';
                                lastChangeDate = '<span class="no-change-needed">不需要</span>';
                                nextChangeDate = '<span class="no-change-needed">不需要</span>';
                                
                            } else if (item.nextChangeDate) {
                                // 需要换土且有下次换土时间
                                const nextChangeDateObj = new Date(item.nextChangeDate);
                                const today = new Date();
                                const diffTime = nextChangeDateObj - today;
                                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                                
                                let statusClass = 'status-active';
                                statusText = '正常';
                                
                                if (diffDays < 0) {
                                    statusClass = 'status-danger';
                                    statusText = '已超期';
                                } else if (diffDays <= 3) {
                                    statusClass = 'status-danger';
                                    statusText = '需立即换土';
                                } else if (diffDays <= 7) {
                                    statusClass = 'status-warning';
                                    statusText = '近期需换土';
                                }
                                
                                statusHTML = `<span class="status-indicator ${statusClass}"></span>`;
                            } else {
                                // 需要换土但没有下次换土时间
                                statusHTML = `<span class="status-indicator status-warning"></span>`;
                                statusText = '未设置换土时间';
                            }
                            
                            // 操作按钮
                            let actionButtons = '';
                            
                            if (needsChange) {
                                // 需要换土的项目（幼虫/蛹）显示换土按钮
                                actionButtons += `
                                <button class="action-btn btn-info record-soil-change" data-id="${item.id}">
                                    <i class="fas fa-seedling"></i> <span class="desktop-only">换土</span>
                                </button>
                                `;
                                
                                // 如果是幼虫，显示羽化按钮
                                if (item.gender === '幼虫' && item.quantity > 0) {
                                    actionButtons += `
                                    <button class="action-btn btn-metamorphosis record-metamorphosis" data-id="${item.id}">
                                        <i class="fas fa-bug"></i> <span class="desktop-only">羽化</span>
                                    </button>
                                    `;
                                }
                            }
                            
                            // 售卖按钮 - 只要数量大于0就可以售卖
                            if (item.quantity > 0) {
                                actionButtons += `
                                <button class="action-btn btn-sale record-sale" data-id="${item.id}">
                                    <i class="fas fa-money-bill-wave"></i> <span class="desktop-only">售卖</span>
                                </button>
                                `;
                            }
                            
                            // 历史按钮 - 只要有历史记录就可以点击
                            const hasHistory = item.changeHistory && item.changeHistory.length > 0;
                            const historyButton = `
                            <button class="action-btn btn-secondary view-history" data-id="${item.id}" ${!hasHistory ? 'disabled style="opacity:0.5;"' : ''}>
                                <i class="fas fa-history"></i> <span class="desktop-only">历史</span>
                            </button>
                            `;
                            
                            // 移动端简化显示
                            const mobileStatus = needsChange ? (statusText.length > 4 ? statusText.substring(0, 4) + '...' : statusText) : '成虫';
                            
                            tableHTML += `
                            <tr data-id="${item.id}">
                                <td>${item.name} ${metamorphosisNote}</td>
                                <td>${item.subcategory || '-'}</td>
                                <td>${item.size || '-'}</td>
                                <td class="${genderClass}">${item.gender || '-'} ${soilHistoryBadge}</td>
                                <td class="editable-cell" data-field="quantity" data-id="${item.id}">
                                    <div class="quantity-display">${item.quantity}</div>
                                </td>
                                <td class="editable-cell" data-field="price" data-id="${item.id}">
                                    <div class="price-display">¥${item.price.toFixed(2)}</div>
                                </td>
                                <td>¥${totalPrice.toFixed(2)}</td>
                                <td class="desktop-only">${lastChangeDate}</td>
                                <td class="desktop-only">${nextChangeDate}</td>
                                <td>
                                    <span class="desktop-only">
                                        ${statusHTML}
                                        ${statusText}
                                    </span>
                                    <span class="mobile-only">
                                        ${statusHTML}
                                        ${mobileStatus}
                                    </span>
                                    ${historyNote}
                                </td>
                                <td class="action-cell">
                                    <button class="action-btn btn-edit edit-item" data-id="${item.id}">
                                        <i class="fas fa-edit"></i> <span class="desktop-only">编辑</span>
                                    </button>
                                    ${actionButtons}
                                    ${historyButton}
                                    <button class="action-btn btn-danger delete-item" data-id="${item.id}">
                                        <i class="fas fa-trash"></i> <span class="desktop-only">删除</span>
                                    </button>
                                </td>
                            </tr>
                            `;
                        });
                    });
                    
                    // 添加当前品名的统计行
                    tableHTML += `
                    <tr class="category-total-row">
                        <td><strong>${name} 总计</strong></td>
                        <td colspan="3" style="text-align: right;"><strong>类别统计：</strong></td>
                        <td><strong>${categoryTotalQuantity}</strong></td>
                        <td>-</td>
                        <td><strong>¥${categoryTotalValue.toFixed(2)}</strong></td>
                        <td colspan="4"></td>
                    </tr>
                    `;
                });
                
                // 添加总计行
                tableHTML += `
                <tr class="grand-total-row">
                    <td><strong>总计</strong></td>
                    <td colspan="3" style="text-align: right;"><strong>全部库存统计：</strong></td>
                    <td><strong>${grandTotalQuantity}</strong></td>
                    <td>-</td>
                    <td><strong>¥${grandTotalValue.toFixed(2)}</strong></td>
                    <td colspan="4"></td>
                </tr>
                `;
                
                tbody.innerHTML = tableHTML;
                updateStats();
                
                // 重新绑定按钮事件
                bindTableEvents();
            }
            
            // 绑定表格事件
            function bindTableEvents() {
                document.querySelectorAll('.delete-item').forEach(button => {
                    button.addEventListener('click', function() {
                        const id = this.getAttribute('data-id');
                        deleteItem(id);
                    });
                });
                
                document.querySelectorAll('.record-soil-change').forEach(button => {
                    button.addEventListener('click', function() {
                        const id = this.getAttribute('data-id');
                        openSoilChangeModal(id);
                    });
                });
                
                document.querySelectorAll('.record-metamorphosis').forEach(button => {
                    button.addEventListener('click', function() {
                        const id = this.getAttribute('data-id');
                        openMetamorphosisModal(id);
                    });
                });
                
                document.querySelectorAll('.record-sale').forEach(button => {
                    button.addEventListener('click', function() {
                        const id = this.getAttribute('data-id');
                        openSaleModal(id);
                    });
                });
                
                document.querySelectorAll('.view-history').forEach(button => {
                    button.addEventListener('click', function() {
                        if (!this.disabled) {
                            const id = this.getAttribute('data-id');
                            openHistoryModal(id);
                        }
                    });
                });
                
                document.querySelectorAll('.edit-item').forEach(button => {
                    button.addEventListener('click', function() {
                        const id = this.getAttribute('data-id');
                        openEditModal(id);
                    });
                });
                
                // 绑定可编辑单元格点击事件
                bindEditableCells();
            }
            
            // 显示销售表格
            function renderSalesTable(searchTerm = '') {
                const tbody = document.getElementById('sales-body');
                const emptyMsg = document.getElementById('empty-sales-message');
                const noResultsMsg = document.getElementById('no-sales-results-message');
                
                // 过滤数据
                let filteredSales = sales;
                if (searchTerm) {
                    const term = searchTerm.toLowerCase();
                    filteredSales = sales.filter(sale => 
                        sale.name.toLowerCase().includes(term) ||
                        (sale.subcategory && sale.subcategory.toLowerCase().includes(term)) ||
                        (sale.notes && sale.notes.toLowerCase().includes(term))
                    );
                }
                
                if (filteredSales.length === 0) {
                    tbody.innerHTML = '';
                    if (searchTerm && sales.length > 0) {
                        emptyMsg.style.display = 'none';
                        noResultsMsg.style.display = 'block';
                    } else {
                        emptyMsg.style.display = 'block';
                        noResultsMsg.style.display = 'none';
                    }
                    return;
                }
                
                emptyMsg.style.display = 'none';
                noResultsMsg.style.display = 'none';
                
                // 按售出日期分组并排序
                const groupedSales = {};
                filteredSales.forEach(sale => {
                    const saleDate = sale.date;
                    if (!groupedSales[saleDate]) {
                        groupedSales[saleDate] = [];
                    }
                    groupedSales[saleDate].push(sale);
                });
                
                // 按售出日期排序（最新的在前面）
                const sortedDates = Object.keys(groupedSales).sort((a, b) => {
                    return new Date(b) - new Date(a);
                });
                
                let tableHTML = '';
                sortedDates.forEach(date => {
                    // 添加日期分组标题行
                    tableHTML += `<tr class="group-header">
                        <td colspan="10">${date}</td>
                    </tr>`;
                    
                    // 添加该日期下的所有销售记录
                    const dateSales = groupedSales[date];
                    dateSales.forEach((sale, index) => {
                        const genderClass = getGenderClass(sale.gender);
                        
                        tableHTML += `
                        <tr data-id="${sale.id}">
                            <td>${sale.date}</td>
                            <td>${sale.name}</td>
                            <td class="desktop-only">${sale.subcategory || '-'}</td>
                            <td class="desktop-only">${sale.size || '-'}</td>
                            <td class="${genderClass}">${sale.gender || '-'}</td>
                            <td>${sale.quantity}</td>
                            <td>¥${sale.price.toFixed(2)}</td>
                            <td>¥${sale.totalPrice.toFixed(2)}</td>
                            <td class="desktop-only">${sale.notes || '-'}</td>
                            <td class="action-cell">
                                <button class="action-btn btn-danger delete-sale" data-id="${sale.id}">
                                    <i class="fas fa-trash"></i> <span class="desktop-only">删除</span>
                                </button>
                            </td>
                        </tr>
                        `;
                    });
                });
                
                tbody.innerHTML = tableHTML;
                
                // 重新绑定删除按钮事件
                document.querySelectorAll('.delete-sale').forEach(button => {
                    button.addEventListener('click', function() {
                        const id = this.getAttribute('data-id');
                        deleteSale(id);
                    });
                });
            }
            
            // 绑定可编辑单元格
            function bindEditableCells() {
                document.querySelectorAll('.editable-cell').forEach(cell => {
                    cell.addEventListener('click', function(e) {
                        // 防止事件冒泡到其他元素
                        if (e.target.tagName === 'INPUT' || e.target.tagName === 'BUTTON') return;
                        
                        const id = this.getAttribute('data-id');
                        const field = this.getAttribute('data-field');
                        const item = inventory.find(item => item.id === id);
                        
                        if (!item) return;
                        
                        // 获取当前值
                        const currentValue = field === 'quantity' ? item.quantity : item.price;
                        const displayElement = this.querySelector(`.${field}-display`);
                        
                        // 创建输入框
                        const input = document.createElement('input');
                        input.type = field === 'quantity' ? 'number' : 'number';
                        input.min = field === 'quantity' ? '1' : '0';
                        input.step = field === 'quantity' ? '1' : '0.01';
                        input.value = currentValue;
                        input.className = 'edit-input';
                        
                        // 保存引用
                        input.dataset.id = id;
                        input.dataset.field = field;
                        input.dataset.originalValue = currentValue;
                        
                        // 替换显示元素
                        this.innerHTML = '';
                        this.appendChild(input);
                        input.focus();
                        
                        // 快速调整按钮
                        if (field === 'quantity') {
                            const buttonContainer = document.createElement('div');
                            buttonContainer.className = 'quick-edit-buttons';
                            
                            const quickButtons = [
                                { text: '+1', value: 1 },
                                { text: '+5', value: 5 },
                                { text: '+10', value: 10 },
                                { text: '-1', value: -1 },
                                { text: '-5', value: -5 },
                                { text: '-10', value: -10 }
                            ];
                            
                            quickButtons.forEach(btn => {
                                const button = document.createElement('button');
                                button.textContent = btn.text;
                                button.className = 'quick-btn';
                                button.addEventListener('click', function() {
                                    const newValue = parseInt(input.value) + btn.value;
                                    if (newValue < 1) {
                                        input.value = 1;
                                    } else {
                                        input.value = newValue;
                                    }
                                });
                                buttonContainer.appendChild(button);
                            });
                            
                            this.appendChild(buttonContainer);
                        }
                        
                        // 处理输入框事件
                        input.addEventListener('blur', saveEdit);
                        input.addEventListener('keydown', function(e) {
                            if (e.key === 'Enter') {
                                saveEdit.call(this);
                            } else if (e.key === 'Escape') {
                                cancelEdit.call(this);
                            }
                        });
                    });
                });
            }
            
            // 保存编辑
            function saveEdit() {
                const input = this;
                const id = input.dataset.id;
                const field = input.dataset.field;
                const originalValue = parseFloat(input.dataset.originalValue);
                let newValue = parseFloat(input.value);
                
                // 验证输入
                if (isNaN(newValue)) {
                    cancelEdit.call(input);
                    return;
                }
                
                // 最小值验证
                if (field === 'quantity' && newValue < 1) {
                    newValue = 1;
                }
                
                if (field === 'price' && newValue < 0) {
                    newValue = 0;
                }
                
                // 查找项目并更新
                const itemIndex = inventory.findIndex(item => item.id === id);
                if (itemIndex === -1) return;
                
                // 更新值
                if (field === 'quantity') {
                    inventory[itemIndex].quantity = newValue;
                } else if (field === 'price') {
                    inventory[itemIndex].price = newValue;
                }
                
                // 保存到本地存储
                localStorage.setItem('beetle-inventory', JSON.stringify(inventory));
                
                // 重新渲染表格
                renderInventoryTable(document.getElementById('search-inventory').value);
                
                // 显示成功消息
                showToast(`${field === 'quantity' ? '数量' : '单价'}已更新`, 'success');
            }
            
            // 取消编辑
            function cancelEdit() {
                const input = this;
                const cell = input.closest('.editable-cell');
                const field = input.dataset.field;
                const originalValue = input.dataset.originalValue;
                
                // 恢复显示
                if (field === 'quantity') {
                    cell.innerHTML = `<div class="quantity-display">${originalValue}</div>`;
                } else if (field === 'price') {
                    cell.innerHTML = `<div class="price-display">¥${parseFloat(originalValue).toFixed(2)}</div>`;
                }
                
                // 重新绑定事件
                bindEditableCells();
            }
            
            // 更新换土提醒列表
            function updateReminders() {
                const reminderList = document.getElementById('reminder-list');
                const today = new Date();
                const nextWeek = new Date();
                nextWeek.setDate(today.getDate() + 7);
                
                // 筛选需要提醒的项目（仅幼虫、蛹、未知，且需要换土的）
                const reminders = inventory.filter(item => {
                    // 只检查需要换土的项目
                    if (!needsSoilChange(item.gender)) return false;
                    
                    // 如果有下次换土时间，检查是否即将到期
                    if (item.nextChangeDate) {
                        const nextChangeDate = new Date(item.nextChangeDate);
                        return nextChangeDate <= nextWeek;
                    }
                    
                    return false;
                });
                
                // 按下次换土时间排序
                reminders.sort((a, b) => {
                    return new Date(a.nextChangeDate) - new Date(b.nextChangeDate);
                });
                
                if (reminders.length === 0) {
                    reminderList.innerHTML = `
                    <div style="text-align: center; padding: 30px; background-color: #f9fdf9; border-radius: 12px; border: 2px dashed #c8e6c9;">
                        <i class="fas fa-check-circle" style="font-size: 2.5rem; color: #4caf50; margin-bottom: 12px; display: block;"></i>
                        <p style="color: #5a7d5c; font-size: 1rem; font-weight: 500;">目前没有需要换土的项目，所有项目状态正常。</p>
                    </div>
                    `;
                    return;
                }
                
                let reminderHTML = '';
                reminders.forEach(item => {
                    const nextChangeDate = new Date(item.nextChangeDate);
                    const diffTime = nextChangeDate - today;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    
                    let reminderClass = 'reminder-item';
                    if (diffDays < 0) {
                        reminderClass += ' danger';
                    } else if (diffDays <= 3) {
                        reminderClass += ' danger';
                    }
                    
                    const daysText = diffDays < 0 ? `超期 ${Math.abs(diffDays)} 天` : `剩余 ${diffDays} 天`;
                    
                    reminderHTML += `
                    <div class="${reminderClass}">
                        <div>
                            <strong>${item.name}</strong>${item.subcategory ? ` - ${item.subcategory}` : ''} - ${item.size || '无尺寸'} - <span class="${getGenderClass(item.gender)}">${item.gender || '未知'}</span>
                            <div style="font-size: 0.9rem; margin-top: 6px; color: #5a7d5c;">
                                <i class="fas fa-hashtag"></i> 数量: ${item.quantity} | <i class="fas fa-calendar-week"></i> 下次换土: ${item.nextChangeDate} <span class="badge ${diffDays < 0 ? 'badge-danger' : diffDays <= 3 ? 'badge-danger' : diffDays <= 7 ? 'badge-warning' : 'badge-success'}">${daysText}</span>
                            </div>
                        </div>
                        <button class="action-btn btn-info record-soil-change" data-id="${item.id}" style="margin: 0; min-width: 100px;">
                            <i class="fas fa-seedling"></i> 记录换土
                        </button>
                    </div>
                    `;
                });
                
                reminderList.innerHTML = reminderHTML;
                
                // 绑定提醒列表中的按钮事件
                document.querySelectorAll('#reminder-list .record-soil-change').forEach(button => {
                    button.addEventListener('click', function() {
                        const id = this.getAttribute('data-id');
                        openSoilChangeModal(id);
                    });
                });
            }
            
            // 生成唯一ID
            function generateId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            }
            
            // 计算三个月后的日期
            function calculateThreeMonthsLater(date) {
                const result = new Date(date);
                result.setMonth(result.getMonth() + 3);
                return result.toISOString().split('T')[0];
            }
            
            // 获取最近一次换土日期
            function getLatestChangeDate(changeHistory) {
                if (!changeHistory || changeHistory.length === 0) return null;
                
                // 按日期排序，获取最近的记录
                const sortedHistory = [...changeHistory].sort((a, b) => {
                    return new Date(b.date) - new Date(a.date);
                });
                
                return sortedHistory[0].date;
            }
            
            // 验证表单
            function validateForm() {
                let isValid = true;
                
                // 重置错误状态
                document.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');
                document.querySelectorAll('input, select').forEach(el => el.classList.remove('input-error'));
                
                // 验证品名
                const name = document.getElementById('item-name').value.trim();
                if (!name) {
                    document.getElementById('name-error').style.display = 'block';
                    document.getElementById('item-name').classList.add('input-error');
                    isValid = false;
                }
                
                // 验证性别
                const gender = document.getElementById('item-gender').value;
                if (!gender) {
                    document.getElementById('gender-error').style.display = 'block';
                    document.getElementById('item-gender').classList.add('input-error');
                    isValid = false;
                }
                
                // 验证数量
                const quantity = parseInt(document.getElementById('item-quantity').value) || 0;
                if (quantity <= 0) {
                    document.getElementById('quantity-error').style.display = 'block';
                    document.getElementById('item-quantity').classList.add('input-error');
                    isValid = false;
                }
                
                // 验证单价
                const price = parseFloat(document.getElementById('item-price').value) || 0;
                if (price < 0) {
                    document.getElementById('price-error').style.display = 'block';
                    document.getElementById('item-price').classList.add('input-error');
                    isValid = false;
                }
                
                return isValid;
            }
            
            // 添加新项目
            function addItem() {
                if (!validateForm()) {
                    return;
                }
                
                const name = document.getElementById('item-name').value.trim();
                const subcategory = document.getElementById('item-subcategory').value.trim();
                const size = document.getElementById('item-size').value.trim();
                const gender = document.getElementById('item-gender').value;
                const quantity = parseInt(document.getElementById('item-quantity').value) || 1;
                const price = parseFloat(document.getElementById('item-price').value) || 0;
                const changeDate = document.getElementById('item-change-date').value;
                
                // 添加到品名列表（如果不存在）
                if (!itemNames.includes(name)) {
                    itemNames.push(name);
                    localStorage.setItem('beetle-item-names', JSON.stringify(itemNames));
                }
                
                // 更新子分类列表
                if (subcategory) {
                    updateSubcategories(name, subcategory);
                }
                
                // 检查是否需要换土
                const needsChange = needsSoilChange(gender);
                
                // 设置换土时间（仅幼虫、蛹、未知需要）
                let lastChangeDate = '';
                let nextChangeDate = '';
                let changeHistory = [];
                
                if (needsChange) {
                    if (changeDate) {
                        lastChangeDate = changeDate;
                        nextChangeDate = calculateThreeMonthsLater(lastChangeDate);
                        changeHistory = [{
                            date: lastChangeDate,
                            notes: '初始记录'
                        }];
                    } else {
                        // 如果没有提供换土时间，使用今天作为默认
                        const today = new Date().toISOString().split('T')[0];
                        lastChangeDate = today;
                        nextChangeDate = calculateThreeMonthsLater(today);
                        changeHistory = [{
                            date: today,
                            notes: '初始记录'
                        }];
                    }
                }
                
                // 创建新项目
                const newItem = {
                    id: generateId(),
                    name: name,
                    subcategory: subcategory || '',
                    size: size,
                    gender: gender,
                    quantity: quantity,
                    price: price,
                    lastChangeDate: lastChangeDate,
                    nextChangeDate: nextChangeDate,
                    changeHistory: changeHistory,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    metamorphosisFrom: null, // 标记是否为羽化生成
                    larvaHistoryPreserved: false // 标记是否保留了幼虫换土记录
                };
                
                inventory.push(newItem);
                localStorage.setItem('beetle-inventory', JSON.stringify(inventory));
                
                // 清空表单
                clearForm();
                
                // 更新表格
                renderInventoryTable();
                
                // 显示成功消息
                showToast('项目添加成功！' + (needsChange && !changeDate ? '已自动设置换土时间为今天。' : ''), 'success');
            }
            
            // 删除项目
            function deleteItem(id) {
                if (confirm('确定要删除这个项目吗？')) {
                    inventory = inventory.filter(item => item.id !== id);
                    localStorage.setItem('beetle-inventory', JSON.stringify(inventory));
                    renderInventoryTable(document.getElementById('search-inventory').value);
                    updateReminders();
                    showToast('项目已删除', 'success');
                }
            }
            
            // 删除销售记录
            function deleteSale(id) {
                if (confirm('确定要删除这条销售记录吗？')) {
                    sales = sales.filter(sale => sale.id !== id);
                    localStorage.setItem('beetle-sales', JSON.stringify(sales));
                    renderSalesTable(document.getElementById('search-sales').value);
                    updateSalesStats();
                    updateStats();
                    showToast('销售记录已删除', 'success');
                }
            }
            
            // 清空表单
            function clearForm() {
                document.getElementById('item-name').value = '';
                document.getElementById('item-subcategory').value = '';
                document.getElementById('item-size').value = '';
                document.getElementById('item-gender').value = '';
                document.getElementById('item-quantity').value = '1';
                document.getElementById('item-price').value = '';
                document.getElementById('item-change-date').value = '';
                document.getElementById('item-next-change-date').value = '';
                document.getElementById('item-change-date').disabled = false;
                document.getElementById('item-next-change-date').disabled = false;
                
                // 清除错误状态
                document.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');
                document.querySelectorAll('input, select').forEach(el => el.classList.remove('input-error'));
            }
            
            // 自动填充换土时间
            document.getElementById('auto-fill-date').addEventListener('click', function() {
                const gender = document.getElementById('item-gender').value;
                if (!needsSoilChange(gender)) {
                    showToast('成虫（公、母）不需要换土时间', 'warning');
                    return;
                }
                
                const today = new Date().toISOString().split('T')[0];
                const nextDate = calculateThreeMonthsLater(today);
                
                document.getElementById('item-change-date').value = today;
                document.getElementById('item-next-change-date').value = nextDate;
                
                showToast('已自动填充换土时间', 'success');
            });
            
            // 打开售卖模态框
            function openSaleModal(id) {
                const item = inventory.find(item => item.id === id);
                if (!item) return;
                
                // 如果数量为0，不能进行售卖操作
                if (item.quantity <= 0) {
                    showToast('该项目数量为0，无法售卖。', 'error');
                    return;
                }
                
                const displayName = item.name + (item.subcategory ? ` (${item.subcategory})` : '');
                document.getElementById('sale-item-name').textContent = `${displayName} - ${item.size || '无尺寸'} - ${item.gender || '未知'}`;
                
                // 设置默认值
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('sale-date').value = today;
                document.getElementById('sale-quantity').value = 1;
                document.getElementById('sale-quantity').max = item.quantity;
                document.getElementById('sale-available-quantity').textContent = item.quantity;
                document.getElementById('sale-price').value = item.price;
                document.getElementById('sale-original-price').textContent = '¥' + item.price.toFixed(2);
                document.getElementById('sale-notes').value = '';
                updateSaleTotalPrice();
                
                // 清除错误状态
                document.querySelectorAll('#sale-modal .error-message').forEach(el => el.style.display = 'none');
                document.querySelectorAll('#sale-modal input').forEach(el => el.classList.remove('input-error'));
                
                // 保存当前项目ID到模态框
                document.getElementById('sale-modal').dataset.itemId = id;
                
                // 显示模态框
                document.getElementById('sale-modal').style.display = 'flex';
                document.getElementById('sale-quantity').focus();
            }
            
            // 更新售卖总价
            function updateSaleTotalPrice() {
                const quantity = parseInt(document.getElementById('sale-quantity').value) || 0;
                const price = parseFloat(document.getElementById('sale-price').value) || 0;
                const totalPrice = quantity * price;
                
                document.getElementById('sale-total-price').value = totalPrice.toFixed(2);
            }
            
            // 验证售卖表单
            function validateSaleForm() {
                let isValid = true;
                
                // 清除错误状态
                document.querySelectorAll('#sale-modal .error-message').forEach(el => el.style.display = 'none');
                document.querySelectorAll('#sale-modal input').forEach(el => el.classList.remove('input-error'));
                
                // 验证售出日期
                const saleDate = document.getElementById('sale-date').value;
                if (!saleDate) {
                    document.getElementById('sale-date-error').style.display = 'block';
                    document.getElementById('sale-date').classList.add('input-error');
                    isValid = false;
                }
                
                // 验证售出数量
                const saleQuantity = parseInt(document.getElementById('sale-quantity').value) || 0;
                const availableQuantity = parseInt(document.getElementById('sale-available-quantity').textContent) || 0;
                if (saleQuantity <= 0 || saleQuantity > availableQuantity) {
                    document.getElementById('sale-quantity-error').style.display = 'block';
                    document.getElementById('sale-quantity').classList.add('input-error');
                    isValid = false;
                }
                
                // 验证售出单价
                const salePrice = parseFloat(document.getElementById('sale-price').value) || 0;
                if (salePrice <= 0) {
                    document.getElementById('sale-price-error').style.display = 'block';
                    document.getElementById('sale-price').classList.add('input-error');
                    isValid = false;
                }
                
                return isValid;
            }
            
            // 保存售卖记录
            function saveSale() {
                if (!validateSaleForm()) {
                    return;
                }
                
                const id = document.getElementById('sale-modal').dataset.itemId;
                const saleDate = document.getElementById('sale-date').value;
                const saleQuantity = parseInt(document.getElementById('sale-quantity').value) || 0;
                const salePrice = parseFloat(document.getElementById('sale-price').value) || 0;
                const saleNotes = document.getElementById('sale-notes').value.trim();
                
                // 查找项目
                const itemIndex = inventory.findIndex(item => item.id === id);
                if (itemIndex === -1) return;
                
                const item = inventory[itemIndex];
                
                // 验证库存数量
                if (saleQuantity > item.quantity) {
                    showToast(`售出数量不能超过库存数量（当前库存：${item.quantity}）`, 'error');
                    return;
                }
                
                // 计算总价
                const totalPrice = saleQuantity * salePrice;
                
                // 1. 创建销售记录
                const newSale = {
                    id: generateId(),
                    itemId: id,
                    date: saleDate,
                    name: item.name,
                    subcategory: item.subcategory || '',
                    size: item.size || '',
                    gender: item.gender,
                    quantity: saleQuantity,
                    price: salePrice,
                    totalPrice: totalPrice,
                    notes: saleNotes,
                    createdAt: new Date().toISOString()
                };
                
                // 添加到销售记录
                sales.push(newSale);
                localStorage.setItem('beetle-sales', JSON.stringify(sales));
                
                // 2. 更新库存
                if (saleQuantity === item.quantity) {
                    // 如果售出数量等于库存数量，从库存中移除该项目
                    inventory.splice(itemIndex, 1);
                } else {
                    // 否则减少库存数量
                    inventory[itemIndex].quantity -= saleQuantity;
                    inventory[itemIndex].updatedAt = new Date().toISOString();
                }
                
                localStorage.setItem('beetle-inventory', JSON.stringify(inventory));
                
                // 3. 关闭模态框
                closeSaleModal();
                
                // 4. 更新表格和统计
                renderInventoryTable(document.getElementById('search-inventory').value);
                renderSalesTable(document.getElementById('search-sales').value);
                updateSalesStats();
                
                // 5. 显示成功消息
                showToast(`售卖记录已保存！成功售出${saleQuantity}只${item.name}，总金额¥${totalPrice.toFixed(2)}。`, 'success');
            }
            
            // 关闭售卖模态框
            function closeSaleModal() {
                document.getElementById('sale-modal').style.display = 'none';
                delete document.getElementById('sale-modal').dataset.itemId;
            }
            
            // 打开幼虫羽化模态框
            function openMetamorphosisModal(id) {
                const item = inventory.find(item => item.id === id);
                if (!item) return;
                
                // 如果不是幼虫，不能进行羽化操作
                if (item.gender !== '幼虫') {
                    showToast('只有幼虫项目可以进行羽化操作。', 'error');
                    return;
                }
                
                // 如果幼虫数量为0，不能进行羽化操作
                if (item.quantity <= 0) {
                    showToast('幼虫数量为0，无法进行羽化操作。', 'error');
                    return;
                }
                
                const displayName = item.name + (item.subcategory ? ` (${item.subcategory})` : '');
                document.getElementById('metamorphosis-item-name').textContent = `${displayName} - 幼虫数量: ${item.quantity}`;
                
                // 设置默认值
                document.getElementById('metamorphosis-gender').value = '';
                document.getElementById('metamorphosis-size').value = item.size || '';
                document.getElementById('metamorphosis-price').value = item.price;
                document.getElementById('metamorphosis-date').valueAsDate = new Date();
                document.getElementById('metamorphosis-notes').value = '';
                
                // 显示幼虫换土历史记录信息
                const historyCountElement = document.getElementById('metamorphosis-history-count');
                const historyCount = item.changeHistory ? item.changeHistory.length : 0;
                historyCountElement.textContent = historyCount;
                
                // 清除错误状态
                document.querySelectorAll('#metamorphosis-modal .error-message').forEach(el => el.style.display = 'none');
                document.querySelectorAll('#metamorphosis-modal input, #metamorphosis-modal select').forEach(el => el.classList.remove('input-error'));
                
                // 保存当前项目ID到模态框
                document.getElementById('metamorphosis-modal').dataset.itemId = id;
                
                // 显示模态框
                document.getElementById('metamorphosis-modal').style.display = 'flex';
            }
            
            // 验证羽化表单
            function validateMetamorphosisForm() {
                let isValid = true;
                
                // 清除错误状态
                document.querySelectorAll('#metamorphosis-modal .error-message').forEach(el => el.style.display = 'none');
                document.querySelectorAll('#metamorphosis-modal input, #metamorphosis-modal select').forEach(el => el.classList.remove('input-error'));
                
                // 验证羽化后性别
                const gender = document.getElementById('metamorphosis-gender').value;
                if (!gender) {
                    document.getElementById('metamorphosis-gender-error').style.display = 'block';
                    document.getElementById('metamorphosis-gender').classList.add('input-error');
                    isValid = false;
                }
                
                // 验证羽化日期
                const date = document.getElementById('metamorphosis-date').value;
                if (!date) {
                    document.getElementById('metamorphosis-date-error').style.display = 'block';
                    document.getElementById('metamorphosis-date').classList.add('input-error');
                    isValid = false;
                }
                
                // 验证单价
                const price = parseFloat(document.getElementById('metamorphosis-price').value) || 0;
                if (price < 0) {
                    document.getElementById('metamorphosis-price-error').style.display = 'block';
                    document.getElementById('metamorphosis-price').classList.add('input-error');
                    isValid = false;
                }
                
                return isValid;
            }
            
            // 保存羽化记录
            function saveMetamorphosis() {
                if (!validateMetamorphosisForm()) {
                    return;
                }
                
                const id = document.getElementById('metamorphosis-modal').dataset.itemId;
                const gender = document.getElementById('metamorphosis-gender').value;
                const size = document.getElementById('metamorphosis-size').value.trim();
                const price = parseFloat(document.getElementById('metamorphosis-price').value) || 0;
                const date = document.getElementById('metamorphosis-date').value;
                const notes = document.getElementById('metamorphosis-notes').value.trim();
                
                // 查找原始幼虫项目
                const larvaIndex = inventory.findIndex(item => item.id === id);
                if (larvaIndex === -1) return;
                
                const larvaItem = inventory[larvaIndex];
                
                // 验证幼虫数量
                if (larvaItem.quantity <= 0) {
                    showToast('幼虫数量不足，无法进行羽化操作。', 'error');
                    closeMetamorphosisModal();
                    return;
                }
                
                // 1. 减少原幼虫项目数量
                inventory[larvaIndex].quantity -= 1;
                inventory[larvaIndex].updatedAt = new Date().toISOString();
                
                // 如果幼虫数量为0，可以删除该项目（可选，这里我们保留）
                
                // 2. 创建新的成虫项目，保留幼虫换土历史记录
                let adultChangeHistory = [];
                
                // 复制幼虫的换土历史记录（如果存在）
                if (larvaItem.changeHistory && larvaItem.changeHistory.length > 0) {
                    adultChangeHistory = JSON.parse(JSON.stringify(larvaItem.changeHistory));
                }
                
                // 添加羽化记录到历史记录中
                adultChangeHistory.push({
                    date: date,
                    notes: notes ? `羽化记录: ${notes}` : '幼虫羽化为成虫'
                });
                
                const newAdultItem = {
                    id: generateId(),
                    name: larvaItem.name,
                    subcategory: larvaItem.subcategory || '',
                    size: size || larvaItem.size || '',
                    gender: gender,
                    quantity: 1,
                    price: price > 0 ? price : larvaItem.price, // 使用指定价格或幼虫价格
                    lastChangeDate: '', // 成虫不需要换土时间
                    nextChangeDate: '', // 成虫不需要换土时间
                    changeHistory: adultChangeHistory, // 保留幼虫换土历史记录并添加羽化记录
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    metamorphosisFrom: {
                        larvaId: larvaItem.id,
                        date: date,
                        originalSize: larvaItem.size,
                        notes: notes || '幼虫羽化'
                    },
                    larvaHistoryPreserved: true // 标记已保留幼虫换土记录
                };
                
                // 3. 添加到库存
                inventory.push(newAdultItem);
                
                // 4. 保存到本地存储
                localStorage.setItem('beetle-inventory', JSON.stringify(inventory));
                
                // 5. 关闭模态框
                closeMetamorphosisModal();
                
                // 6. 更新表格
                renderInventoryTable(document.getElementById('search-inventory').value);
                
                // 7. 显示成功消息
                showToast('羽化记录已保存！原幼虫数量减1，已创建新的成虫项目并保留幼虫时期的换土历史记录。', 'success');
            }
            
            // 关闭羽化模态框
            function closeMetamorphosisModal() {
                document.getElementById('metamorphosis-modal').style.display = 'none';
                delete document.getElementById('metamorphosis-modal').dataset.itemId;
            }
            
            // 打开记录换土模态框
            function openSoilChangeModal(id) {
                const item = inventory.find(item => item.id === id);
                if (!item) return;
                
                // 如果是成虫，不需要换土
                if (!needsSoilChange(item.gender)) {
                    showToast('成虫（公、母）不需要换土，只需定期清洁和喂食即可。但会保留换土历史记录。', 'warning');
                    return;
                }
                
                const displayName = item.name + (item.subcategory ? ` (${item.subcategory})` : '');
                document.getElementById('modal-item-name').textContent = `${displayName} - ${item.size || '无尺寸'} - ${item.gender || '未知'}`;
                document.getElementById('soil-change-date').valueAsDate = new Date();
                document.getElementById('soil-notes').value = '';
                
                // 清除错误状态
                document.querySelectorAll('#change-soil-modal .error-message').forEach(el => el.style.display = 'none');
                document.querySelectorAll('#change-soil-modal input').forEach(el => el.classList.remove('input-error'));
                
                // 保存当前项目ID到模态框
                document.getElementById('change-soil-modal').dataset.itemId = id;
                
                // 显示模态框
                document.getElementById('change-soil-modal').style.display = 'flex';
            }
            
            // 保存换土记录
            function saveSoilChange() {
                const id = document.getElementById('change-soil-modal').dataset.itemId;
                const changeDate = document.getElementById('soil-change-date').value;
                const notes = document.getElementById('soil-notes').value.trim();
                
                // 验证换土日期
                if (!changeDate) {
                    document.getElementById('soil-date-error').style.display = 'block';
                    document.getElementById('soil-change-date').classList.add('input-error');
                    return;
                }
                
                const itemIndex = inventory.findIndex(item => item.id === id);
                if (itemIndex === -1) return;
                
                // 确保是需要换土的项目
                if (!needsSoilChange(inventory[itemIndex].gender)) {
                    showToast('错误：成虫不需要换土！但换土历史记录会保留。', 'error');
                    closeSoilChangeModal();
                    return;
                }
                
                // 更新换土记录
                const nextChangeDate = calculateThreeMonthsLater(changeDate);
                
                inventory[itemIndex].lastChangeDate = changeDate;
                inventory[itemIndex].nextChangeDate = nextChangeDate;
                inventory[itemIndex].updatedAt = new Date().toISOString();
                
                // 添加换土历史记录
                if (!inventory[itemIndex].changeHistory) {
                    inventory[itemIndex].changeHistory = [];
                }
                
                inventory[itemIndex].changeHistory.push({
                    date: changeDate,
                    notes: notes || '换土记录'
                });
                
                // 保存到本地存储
                localStorage.setItem('beetle-inventory', JSON.stringify(inventory));
                
                // 关闭模态框
                closeSoilChangeModal();
                
                // 更新表格和提醒
                renderInventoryTable(document.getElementById('search-inventory').value);
                updateReminders();
                
                showToast('换土记录已保存！', 'success');
            }
            
            // 关闭记录换土模态框
            function closeSoilChangeModal() {
                document.getElementById('change-soil-modal').style.display = 'none';
                delete document.getElementById('change-soil-modal').dataset.itemId;
            }
            
            // 打开编辑项目模态框
            function openEditModal(id) {
                const item = inventory.find(item => item.id === id);
                if (!item) return;
                
                // 填充表单
                document.getElementById('edit-item-name').value = item.name;
                document.getElementById('edit-item-subcategory').value = item.subcategory || '';
                document.getElementById('edit-item-size').value = item.size || '';
                document.getElementById('edit-item-gender').value = item.gender || '';
                document.getElementById('edit-item-quantity').value = item.quantity;
                document.getElementById('edit-item-price').value = item.price;
                
                // 换土时间字段（仅幼虫、蛹、未知显示）
                const needsChange = needsSoilChange(item.gender);
                const hasHistory = item.changeHistory && item.changeHistory.length > 0;
                
                if (needsChange) {
                    // 需要换土的项目，显示最近的换土时间
                    document.getElementById('edit-item-last-change').value = item.lastChangeDate || '';
                    document.getElementById('edit-item-next-change').value = item.nextChangeDate || '';
                    
                    // 启用换土时间字段
                    document.getElementById('edit-item-last-change').disabled = false;
                    document.getElementById('edit-item-next-change').disabled = false;
                } else {
                    // 成虫不需要换土时间，但如果有历史记录，显示最近一次换土时间
                    if (hasHistory) {
                        const latestChangeDate = getLatestChangeDate(item.changeHistory);
                        document.getElementById('edit-item-last-change').value = latestChangeDate || '';
                        document.getElementById('edit-item-next-change').value = '';
                    } else {
                        document.getElementById('edit-item-last-change').value = '';
                        document.getElementById('edit-item-next-change').value = '';
                    }
                    
                    // 禁用换土时间字段
                    document.getElementById('edit-item-last-change').disabled = true;
                    document.getElementById('edit-item-next-change').disabled = true;
                }
                
                // 显示历史记录信息
                const historyInfo = document.getElementById('edit-history-info');
                const historyCount = document.getElementById('edit-history-count');
                
                if (hasHistory) {
                    historyCount.textContent = item.changeHistory.length;
                    historyInfo.style.display = 'block';
                } else {
                    historyInfo.style.display = 'none';
                }
                
                // 清除错误状态
                document.querySelectorAll('#edit-item-modal .error-message').forEach(el => el.style.display = 'none');
                document.querySelectorAll('#edit-item-modal input, #edit-item-modal select').forEach(el => el.classList.remove('input-error'));
                
                // 保存当前项目ID到模态框
                document.getElementById('edit-item-modal').dataset.itemId = id;
                
                // 显示模态框
                document.getElementById('edit-item-modal').style.display = 'flex';
            }
            
            // 验证编辑表单
            function validateEditForm() {
                let isValid = true;
                
                // 清除错误状态
                document.querySelectorAll('#edit-item-modal .error-message').forEach(el => el.style.display = 'none');
                document.querySelectorAll('#edit-item-modal input, #edit-item-modal select').forEach(el => el.classList.remove('input-error'));
                
                // 验证品名
                const name = document.getElementById('edit-item-name').value.trim();
                if (!name) {
                    document.getElementById('edit-name-error').style.display = 'block';
                    document.getElementById('edit-item-name').classList.add('input-error');
                    isValid = false;
                }
                
                // 验证性别
                const gender = document.getElementById('edit-item-gender').value;
                if (!gender) {
                    document.getElementById('edit-gender-error').style.display = 'block';
                    document.getElementById('edit-item-gender').classList.add('input-error');
                    isValid = false;
                }
                
                // 验证数量
                const quantity = parseInt(document.getElementById('edit-item-quantity').value) || 0;
                if (quantity <= 0) {
                    document.getElementById('edit-quantity-error').style.display = 'block';
                    document.getElementById('edit-item-quantity').classList.add('input-error');
                    isValid = false;
                }
                
                // 验证单价
                const price = parseFloat(document.getElementById('edit-item-price').value) || 0;
                if (price < 0) {
                    document.getElementById('edit-price-error').style.display = 'block';
                    document.getElementById('edit-item-price').classList.add('input-error');
                    isValid = false;
                }
                
                return isValid;
            }
            
            // 保存编辑
            function saveItemEdit() {
                if (!validateEditForm()) {
                    return;
                }
                
                const id = document.getElementById('edit-item-modal').dataset.itemId;
                const name = document.getElementById('edit-item-name').value.trim();
                const subcategory = document.getElementById('edit-item-subcategory').value.trim();
                const size = document.getElementById('edit-item-size').value.trim();
                const gender = document.getElementById('edit-item-gender').value;
                const quantity = parseInt(document.getElementById('edit-item-quantity').value) || 1;
                const price = parseFloat(document.getElementById('edit-item-price').value) || 0;
                const lastChangeDate = document.getElementById('edit-item-last-change').value;
                const nextChangeDate = document.getElementById('edit-item-next-change').value;
                
                const itemIndex = inventory.findIndex(item => item.id === id);
                if (itemIndex === -1) return;
                
                // 检查是否需要换土
                const newNeedsChange = needsSoilChange(gender);
                const oldNeedsChange = needsSoilChange(inventory[itemIndex].gender);
                
                // 获取旧的换土历史记录
                const oldChangeHistory = inventory[itemIndex].changeHistory || [];
                
                // 更新品名列表（如果品名改变）
                const oldName = inventory[itemIndex].name;
                if (oldName !== name && !itemNames.includes(name)) {
                    itemNames.push(name);
                    localStorage.setItem('beetle-item-names', JSON.stringify(itemNames));
                }
                
                // 更新子分类列表
                if (subcategory && inventory[itemIndex].subcategory !== subcategory) {
                    updateSubcategories(name, subcategory);
                }
                
                // 更新项目基本信息
                inventory[itemIndex].name = name;
                inventory[itemIndex].subcategory = subcategory || '';
                inventory[itemIndex].size = size;
                inventory[itemIndex].gender = gender;
                inventory[itemIndex].quantity = quantity;
                inventory[itemIndex].price = price;
                inventory[itemIndex].updatedAt = new Date().toISOString();
                
                // 处理换土时间和历史记录
                if (newNeedsChange) {
                    // 新状态需要换土
                    if (lastChangeDate) {
                        // 有最近换土时间
                        inventory[itemIndex].lastChangeDate = lastChangeDate;
                        
                        // 如果有下次换土时间，使用它，否则计算三个月后
                        if (nextChangeDate) {
                            inventory[itemIndex].nextChangeDate = nextChangeDate;
                        } else {
                            inventory[itemIndex].nextChangeDate = calculateThreeMonthsLater(lastChangeDate);
                        }
                    } else {
                        // 没有最近换土时间
                        inventory[itemIndex].lastChangeDate = '';
                        inventory[itemIndex].nextChangeDate = '';
                    }
                    
                    // 保留历史记录（如果从成虫变为幼虫/蛹，保留历史记录）
                    if (!oldNeedsChange && oldChangeHistory.length > 0) {
                        // 从成虫变为幼虫/蛹，保留历史记录
                        inventory[itemIndex].changeHistory = oldChangeHistory;
                        inventory[itemIndex].larvaHistoryPreserved = false; // 重置标记
                    } else if (oldNeedsChange) {
                        // 本来就是幼虫/蛹，保留历史记录
                        inventory[itemIndex].changeHistory = oldChangeHistory;
                    } else {
                        // 没有历史记录，保持为空
                        if (!inventory[itemIndex].changeHistory) {
                            inventory[itemIndex].changeHistory = [];
                        }
                    }
                } else {
                    // 新状态是成虫，不需要换土时间
                    inventory[itemIndex].lastChangeDate = '';
                    inventory[itemIndex].nextChangeDate = '';
                    
                    // 保留历史记录（如果原来有）
                    if (oldChangeHistory.length > 0) {
                        inventory[itemIndex].changeHistory = oldChangeHistory;
                    } else {
                        inventory[itemIndex].changeHistory = [];
                    }
                    
                    // 如果是羽化生成的成虫，保持标记
                    if (!inventory[itemIndex].metamorphosisFrom) {
                        inventory[itemIndex].larvaHistoryPreserved = false;
                    }
                }
                
                // 保存到本地存储
                localStorage.setItem('beetle-inventory', JSON.stringify(inventory));
                
                // 关闭模态框
                closeEditModal();
                
                // 更新表格
                renderInventoryTable(document.getElementById('search-inventory').value);
                
                // 显示提示信息
                let message = '项目编辑成功！';
                if (oldNeedsChange && !newNeedsChange) {
                    message += '已从幼虫/蛹状态改为成虫，换土时间已清空，但历史记录已保留。';
                } else if (!oldNeedsChange && newNeedsChange) {
                    message += '已从成虫状态改为幼虫/蛹，可以使用之前的换土历史记录。';
                }
                showToast(message, 'success');
            }
            
            // 关闭编辑模态框
            function closeEditModal() {
                document.getElementById('edit-item-modal').style.display = 'none';
                delete document.getElementById('edit-item-modal').dataset.itemId;
                
                // 重置表单
                document.getElementById('edit-item-last-change').disabled = false;
                document.getElementById('edit-item-next-change').disabled = false;
                document.getElementById('edit-history-info').style.display = 'none';
            }
            
            // 打开历史记录模态框
            function openHistoryModal(id) {
                const item = inventory.find(item => item.id === id);
                if (!item) return;
                
                // 如果没有换土历史记录，不显示
                if (!item.changeHistory || item.changeHistory.length === 0) {
                    showToast('此项目没有换土历史记录。', 'warning');
                    return;
                }
                
                const displayName = item.name + (item.subcategory ? ` (${item.subcategory})` : '');
                let genderText = '';
                
                if (!needsSoilChange(item.gender)) {
                    genderText = '（成虫）';
                    if (item.metamorphosisFrom) {
                        genderText = '（羽化生成）';
                    }
                }
                
                document.getElementById('history-item-name').textContent = `${displayName} - 换土历史记录${genderText}`;
                
                let historyHTML = '';
                
                // 按日期排序（最近的在前面）
                const sortedHistory = [...item.changeHistory].sort((a, b) => {
                    return new Date(b.date) - new Date(a.date);
                });
                
                // 添加标题说明
                if (item.metamorphosisFrom && item.larvaHistoryPreserved) {
                    historyHTML += `
                    <div style="padding: 12px; background-color: #e8f5e9; border-radius: 8px; margin-bottom: 15px; border: 1px solid #c8e6c9;">
                        <p style="font-size: 0.9rem; color: #2d572c; margin: 0;">
                            <i class="fas fa-info-circle"></i> 此成虫由幼虫羽化生成，保留了幼虫时期的换土历史记录。
                        </p>
                    </div>
                    `;
                }
                
                sortedHistory.forEach(record => {
                    const historyDate = new Date(record.date).toLocaleDateString();
                    // 标记羽化记录
                    const isMetamorphosisRecord = record.notes && record.notes.includes('羽化记录');
                    const recordClass = isMetamorphosisRecord ? 'style="background-color: #fff3e0; padding: 10px; border-radius: 8px; border-left: 4px solid #ff9800;"' : 'style="padding: 10px; border-radius: 8px; border-left: 4px solid #4caf50;"';
                    
                    historyHTML += `
                    <div class="history-item" ${recordClass}>
                        <span class="history-date"><i class="fas fa-calendar-day"></i> ${historyDate}</span>
                        <span>${record.notes || '换土记录'}</span>
                    </div>
                    `;
                });
                
                document.getElementById('history-list').innerHTML = historyHTML;
                
                // 显示模态框
                document.getElementById('history-modal').style.display = 'flex';
            }
            
            // 关闭历史记录模态框
            function closeHistoryModal() {
                document.getElementById('history-modal').style.display = 'none';
            }
            
            // 保存到本地存储
            function saveToLocalStorage() {
                localStorage.setItem('beetle-inventory', JSON.stringify(inventory));
                localStorage.setItem('beetle-sales', JSON.stringify(sales));
                localStorage.setItem('beetle-item-names', JSON.stringify(itemNames));
                localStorage.setItem('beetle-subcategories', JSON.stringify(subcategories));
                localStorage.setItem('beetle-last-backup', new Date().toISOString());
                
                // 隐藏备份提醒
                document.getElementById('backup-notice').classList.remove('show');
                
                // 更新数据统计
                updateDataStats();
                
                showToast('数据已保存到本地存储！', 'success');
            }
            
            // 从本地存储加载
            function loadFromLocalStorage() {
                const savedInventory = JSON.parse(localStorage.getItem('beetle-inventory'));
                const savedSales = JSON.parse(localStorage.getItem('beetle-sales'));
                const savedItemNames = JSON.parse(localStorage.getItem('beetle-item-names'));
                const savedSubcategories = JSON.parse(localStorage.getItem('beetle-subcategories'));
                
                if (savedInventory) {
                    inventory = savedInventory;
                    sales = savedSales || [];
                    itemNames = savedItemNames || [];
                    subcategories = savedSubcategories || {};
                    
                    localStorage.setItem('beetle-inventory', JSON.stringify(inventory));
                    localStorage.setItem('beetle-sales', JSON.stringify(sales));
                    localStorage.setItem('beetle-item-names', JSON.stringify(itemNames));
                    localStorage.setItem('beetle-subcategories', JSON.stringify(subcategories));
                    
                    renderInventoryTable(document.getElementById('search-inventory').value);
                    renderSalesTable(document.getElementById('search-sales').value);
                    updateReminders();
                    updateSalesStats();
                    updateDataStats();
                    
                    showToast('数据已从本地存储加载！', 'success');
                } else {
                    showToast('本地存储中没有找到数据！', 'error');
                }
            }
            
            // 导出为JSON文件
            function exportToJSON() {
                const data = {
                    inventory: inventory,
                    sales: sales,
                    itemNames: itemNames,
                    subcategories: subcategories,
                    exportedAt: new Date().toISOString()
                };
                
                const dataStr = JSON.stringify(data, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const exportFileDefaultName = `甲虫库存_${new Date().toISOString().slice(0,10)}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                
                // 更新最后备份时间
                localStorage.setItem('beetle-last-backup', new Date().toISOString());
                updateDataStats();
                
                showToast('数据已导出为JSON文件！', 'success');
            }
            
            // 导入JSON文件
            function importFromJSON() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                
                input.onchange = function(event) {
                    const file = event.target.files[0];
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        try {
                            const data = JSON.parse(e.target.result);
                            
                            if (data.inventory) {
                                if (confirm('导入数据将覆盖当前数据，确定要继续吗？')) {
                                    inventory = data.inventory;
                                    sales = data.sales || [];
                                    itemNames = data.itemNames || [];
                                    subcategories = data.subcategories || {};
                                    
                                    localStorage.setItem('beetle-inventory', JSON.stringify(inventory));
                                    localStorage.setItem('beetle-sales', JSON.stringify(sales));
                                    localStorage.setItem('beetle-item-names', JSON.stringify(itemNames));
                                    localStorage.setItem('beetle-subcategories', JSON.stringify(subcategories));
                                    
                                    renderInventoryTable();
                                    renderSalesTable();
                                    updateReminders();
                                    updateSalesStats();
                                    updateDataStats();
                                    
                                    showToast('数据导入成功！', 'success');
                                }
                            } else {
                                showToast('文件格式不正确！', 'error');
                            }
                        } catch (error) {
                            showToast('导入失败：' + error.message, 'error');
                        }
                    };
                    
                    reader.readAsText(file);
                };
                
                input.click();
            }
            
            // 导出为Excel
            function exportToExcel() {
                if (inventory.length === 0) {
                    showToast('没有数据可以导出！', 'error');
                    return;
                }
                
                // 准备Excel数据
                const excelData = inventory.map(item => {
                    // 计算幼虫时期换土记录数量（排除羽化记录）
                    let larvaHistoryCount = 0;
                    if (item.changeHistory && item.changeHistory.length > 0) {
                        larvaHistoryCount = item.changeHistory.filter(record => 
                            !record.notes || !record.notes.includes('羽化记录')
                        ).length;
                    }
                    
                    return {
                        '品名': item.name,
                        '子分类': item.subcategory || '',
                        '尺寸': item.size || '',
                        '性别/阶段': item.gender || '',
                        '数量': item.quantity,
                        '单价': item.price,
                        '总价': item.quantity * item.price,
                        '最近换土时间': item.lastChangeDate || '',
                        '下次换土时间': item.nextChangeDate || '',
                        '状态': getStatusText(item),
                        '是否为羽化生成': item.metamorphosisFrom ? '是' : '否',
                        '幼虫换土记录数量': larvaHistoryCount,
                        '总历史记录数量': item.changeHistory ? item.changeHistory.length : 0,
                        '创建时间': item.createdAt ? new Date(item.createdAt).toLocaleDateString() : '',
                        '最后更新': item.updatedAt ? new Date(item.updatedAt).toLocaleDateString() : ''
                    };
                });
                
                // 创建工作簿和工作表
                const ws = XLSX.utils.json_to_sheet(excelData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "甲虫库存");
                
                // 导出文件
                const fileName = `甲虫库存_${new Date().toISOString().slice(0,10)}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                // 更新最后备份时间
                localStorage.setItem('beetle-last-backup', new Date().toISOString());
                updateDataStats();
                
                showToast('数据已导出为Excel文件！', 'success');
            }
            
            // 导出销售记录为Excel
            function exportSalesToExcel() {
                if (sales.length === 0) {
                    showToast('没有销售记录可以导出！', 'error');
                    return;
                }
                
                // 准备Excel数据
                const excelData = sales.map(sale => {
                    return {
                        '售出日期': sale.date,
                        '品名': sale.name,
                        '子分类': sale.subcategory || '',
                        '尺寸': sale.size || '',
                        '性别/阶段': sale.gender || '',
                        '数量': sale.quantity,
                        '单价': sale.price,
                        '总价': sale.totalPrice,
                        '备注': sale.notes || '',
                        '记录时间': sale.createdAt ? new Date(sale.createdAt).toLocaleDateString() : ''
                    };
                });
                
                // 创建工作簿和工作表
                const ws = XLSX.utils.json_to_sheet(excelData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "销售记录");
                
                // 导出文件
                const fileName = `甲虫销售记录_${new Date().toISOString().slice(0,10)}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                showToast('销售记录已导出为Excel文件！', 'success');
            }
            
            // 获取状态文本
            function getStatusText(item) {
                // 成虫不需要换土
                if (!needsSoilChange(item.gender)) {
                    let additionalInfo = '';
                    if (item.metamorphosisFrom && item.larvaHistoryPreserved) {
                        // 计算幼虫时期换土记录数量
                        const larvaHistoryCount = item.changeHistory ? 
                            item.changeHistory.filter(record => !record.notes || !record.notes.includes('羽化记录')).length : 0;
                        if (larvaHistoryCount > 0) {
                            additionalInfo = `，保留幼虫时期${larvaHistoryCount}条换土记录`;
                        }
                    } else if (item.changeHistory && item.changeHistory.length > 0) {
                        additionalInfo = '，有历史记录';
                    }
                    return `成虫（无需换土）${additionalInfo}`;
                }
                
                // 幼虫/蛹但没有设置换土时间
                if (!item.nextChangeDate) {
                    return '未设置换土时间';
                }
                
                const changeDateObj = new Date(item.nextChangeDate);
                const today = new Date();
                const diffTime = changeDateObj - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                if (diffDays < 0) return '已超期';
                if (diffDays <= 3) return '需立即换土';
                if (diffDays <= 7) return '近期需换土';
                return '正常';
            }
            
            // 清空所有数据
            function clearAllData() {
                if (confirm('确定要清空所有数据吗？此操作将清空库存、销售记录和所有其他数据，不可撤销！')) {
                    inventory = [];
                    sales = [];
                    itemNames = [];
                    subcategories = {};
                    localStorage.removeItem('beetle-inventory');
                    localStorage.removeItem('beetle-sales');
                    localStorage.removeItem('beetle-item-names');
                    localStorage.removeItem('beetle-subcategories');
                    localStorage.removeItem('beetle-last-backup');
                    renderInventoryTable();
                    renderSalesTable();
                    updateReminders();
                    updateSalesStats();
                    updateDataStats();
                    showToast('所有数据已清空！', 'success');
                }
            }
            
            // 清空销售记录
            function clearSalesData() {
                if (confirm('确定要清空所有销售记录吗？此操作不可撤销！')) {
                    sales = [];
                    localStorage.setItem('beetle-sales', JSON.stringify(sales));
                    renderSalesTable();
                    updateSalesStats();
                    updateStats();
                    showToast('销售记录已清空！', 'success');
                }
            }
            
            // 立即备份
            document.getElementById('backup-now').addEventListener('click', function() {
                saveToLocalStorage();
                document.getElementById('backup-notice').classList.remove('show');
            });
            
            // 事件监听
            document.getElementById('add-item').addEventListener('click', addItem);
            document.getElementById('clear-form').addEventListener('click', clearForm);
            document.getElementById('save-local').addEventListener('click', saveToLocalStorage);
            document.getElementById('load-local').addEventListener('click', loadFromLocalStorage);
            document.getElementById('export-json').addEventListener('click', exportToJSON);
            document.getElementById('import-json').addEventListener('click', importFromJSON);
            document.getElementById('export-excel').addEventListener('click', exportToExcel);
            document.getElementById('export-sales-excel').addEventListener('click', exportSalesToExcel);
            document.getElementById('clear-data').addEventListener('click', clearAllData);
            document.getElementById('clear-sales').addEventListener('click', clearSalesData);
            
            // 售卖模态框事件
            document.getElementById('save-sale').addEventListener('click', saveSale);
            document.getElementById('cancel-sale').addEventListener('click', closeSaleModal);
            
            // 售卖数量或价格变化时更新总价
            document.getElementById('sale-quantity').addEventListener('input', updateSaleTotalPrice);
            document.getElementById('sale-price').addEventListener('input', updateSaleTotalPrice);
            
            // 模态框事件
            document.getElementById('save-soil-change').addEventListener('click', saveSoilChange);
            document.getElementById('cancel-soil-change').addEventListener('click', closeSoilChangeModal);
            document.getElementById('save-item-edit').addEventListener('click', saveItemEdit);
            document.getElementById('cancel-item-edit').addEventListener('click', closeEditModal);
            document.getElementById('save-metamorphosis').addEventListener('click', saveMetamorphosis);
            document.getElementById('cancel-metamorphosis').addEventListener('click', closeMetamorphosisModal);
            document.getElementById('close-history').addEventListener('click', closeHistoryModal);
            
            // 关闭模态框的按钮
            document.querySelectorAll('.close-modal').forEach(button => {
                button.addEventListener('click', function() {
                    this.closest('.modal').style.display = 'none';
                });
            });
            
            // 点击模态框外部关闭
            window.addEventListener('click', function(event) {
                if (event.target.classList.contains('modal')) {
                    event.target.style.display = 'none';
                }
            });
            
            // 搜索功能
            document.getElementById('search-inventory').addEventListener('input', function() {
                renderInventoryTable(this.value);
            });
            
            document.getElementById('search-sales').addEventListener('input', function() {
                renderSalesTable(this.value);
            });
            
            // 设置默认日期为今天
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            document.getElementById('item-change-date').value = todayStr;
            document.getElementById('item-next-change-date').value = calculateThreeMonthsLater(todayStr);
            document.getElementById('soil-change-date').value = todayStr;
            document.getElementById('metamorphosis-date').value = todayStr;
            document.getElementById('sale-date').value = todayStr;
            
            // 性别选择变化时，控制换土时间字段
            document.getElementById('item-gender').addEventListener('change', function() {
                const gender = this.value;
                const changeDateField = document.getElementById('item-change-date');
                const nextChangeDateField = document.getElementById('item-next-change-date');
                
                if (!needsSoilChange(gender)) {
                    // 成虫不需要换土时间
                    changeDateField.value = '';
                    nextChangeDateField.value = '';
                    changeDateField.disabled = true;
                    nextChangeDateField.disabled = true;
                } else {
                    changeDateField.disabled = false;
                    nextChangeDateField.disabled = false;
                    if (!changeDateField.value) {
                        changeDateField.value = todayStr;
                        nextChangeDateField.value = calculateThreeMonthsLater(todayStr);
                    }
                }
            });
            
            // 编辑模态框性别选择变化
            document.getElementById('edit-item-gender').addEventListener('change', function() {
                const gender = this.value;
                const lastChangeField = document.getElementById('edit-item-last-change');
                const nextChangeField = document.getElementById('edit-item-next-change');
                
                if (!needsSoilChange(gender)) {
                    // 成虫不需要换土时间，禁用字段
                    lastChangeField.disabled = true;
                    nextChangeField.disabled = true;
                } else {
                    // 幼虫/蛹需要换土时间，启用字段
                    lastChangeField.disabled = false;
                    nextChangeField.disabled = false;
                }
            });
            
            // 初始渲染
            renderInventoryTable();
            renderSalesTable();
            updateReminders();
            updateSalesStats();
            updateDataStats();
            
            // 检查是否有数据，显示备份提醒
            if (inventory.length > 0) {
                const lastBackup = localStorage.getItem('beetle-last-backup');
                const oneWeekAgo = new Date();
                oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
                
                if (!lastBackup || new Date(lastBackup) < oneWeekAgo) {
                    setTimeout(() => {
                        document.getElementById('backup-notice').classList.add('show');
                    }, 3000);
                }
            }
        });
    </script>
</body>
</html>