<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>甲虫库存管理工具 - wenbin出品</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* 重置样式 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Helvetica Neue', sans-serif;
        }
        
        :root {
            --primary-color: #3c763d;
            --secondary-color: #4caf50;
            --accent-color: #2d572c;
            --background-color: #f8faf9;
            --card-color: #ffffff;
            --text-color: #2c3e2d;
            --text-light: #8a9c8b;
            --border-color: #e0f2e0;
            --danger-color: #f44336;
            --warning-color: #ff9800;
            --info-color: #2196f3;
            --success-color: #4caf50;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --shadow-heavy: 0 8px 24px rgba(0, 0, 0, 0.12);
        }
        
        body {
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            padding: 0;
            -webkit-font-smoothing: antialiased;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* 主要容器 */
        .container {
            width: 100%;
            min-height: 100vh;
            background-color: var(--background-color);
        }
        
        /* 头部 */
        .header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
            color: white;
            padding: 20px 15px;
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            opacity: 0.3;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            z-index: 1;
            position: relative;
        }
        
        .logo {
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            padding: 12px;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        .logo i {
            font-size: 2.2rem;
            color: white;
        }
        
        .title-area {
            display: flex;
            flex-direction: column;
            gap: 5px;
            flex: 1;
        }
        
        .title {
            font-size: 1.6rem;
            font-weight: 700;
            letter-spacing: 0.3px;
            background: linear-gradient(to right, #ffffff, #f1f8e9);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .brand {
            font-size: 0.9rem;
            font-weight: 500;
            opacity: 0.9;
            background-color: rgba(255, 255, 255, 0.2);
            padding: 4px 10px;
            border-radius: 15px;
            display: inline-block;
            max-width: fit-content;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* 统计卡片 */
        .stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            z-index: 1;
            position: relative;
        }
        
        .stat-card {
            background-color: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            padding: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            background-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-3px);
        }
        
        .stat-title {
            font-size: 0.85rem;
            opacity: 0.9;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        /* 标签切换 */
        .tabs-container {
            background-color: var(--card-color);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .tabs {
            display: flex;
            overflow-x: auto;
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE and Edge */
            padding: 0 15px;
            background-color: var(--card-color);
        }
        
        .tabs::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }
        
        .tab {
            padding: 15px 12px;
            background: none;
            border: none;
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-light);
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            white-space: nowrap;
            position: relative;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        
        .tab i {
            font-size: 1.1rem;
        }
        
        /* 内容区域 */
        .content {
            padding: 15px;
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* 卡片样式 */
        .card {
            background-color: var(--card-color);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
            background: linear-gradient(to bottom, var(--secondary-color), var(--primary-color));
            border-radius: 5px 0 0 5px;
        }
        
        .card-title {
            font-size: 1.3rem;
            color: var(--primary-color);
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #f0f9f0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .card-title i {
            color: var(--secondary-color);
            background-color: rgba(76, 175, 80, 0.1);
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* 表单样式 */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        label {
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.95rem;
        }
        
        label i {
            color: var(--secondary-color);
            font-size: 0.9rem;
        }
        
        input, select {
            padding: 14px 15px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s;
            background-color: #f9fdf9;
            color: var(--text-color);
            -webkit-appearance: none;
            appearance: none;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
            background-color: white;
        }
        
        .input-hint {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-top: 5px;
        }
        
        /* 按钮组 */
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 15px;
        }
        
        button {
            padding: 14px 20px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
            flex: 1;
            min-width: 120px;
        }
        
        button:active {
            transform: scale(0.98);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--secondary-color) 0%, var(--primary-color) 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.2);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #607d8b 0%, #546e7a 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(96, 125, 139, 0.1);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color) 0%, #d32f2f 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.1);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color) 0%, #f57c00 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(255, 152, 0, 0.1);
        }
        
        .btn-info {
            background: linear-gradient(135deg, var(--info-color) 0%, #1976d2 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.1);
        }
        
        /* 库存列表卡片样式 - 移动端优化 */
        .inventory-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .inventory-item {
            background-color: var(--card-color);
            border-radius: 15px;
            padding: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .inventory-item:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-heavy);
        }
        
        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 1px solid #f0f9f0;
        }
        
        .item-name {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-color);
            line-height: 1.3;
        }
        
        .item-subcategory {
            font-size: 0.95rem;
            color: var(--text-light);
            margin-top: 3px;
        }
        
        .item-status {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            white-space: nowrap;
        }
        
        .status-active {
            background-color: rgba(76, 175, 80, 0.1);
            color: var(--success-color);
        }
        
        .status-warning {
            background-color: rgba(255, 152, 0, 0.1);
            color: var(--warning-color);
        }
        
        .status-danger {
            background-color: rgba(244, 67, 54, 0.1);
            color: var(--danger-color);
        }
        
        .item-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .detail-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .detail-label {
            font-size: 0.85rem;
            color: var(--text-light);
            font-weight: 500;
        }
        
        .detail-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-color);
        }
        
        .detail-value.gender-adult {
            color: #9c27b0;
        }
        
        .detail-value.gender-larva {
            color: var(--success-color);
        }
        
        .detail-value.gender-pupa {
            color: var(--warning-color);
        }
        
        .item-footer {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding-top: 15px;
            border-top: 1px solid #f0f9f0;
        }
        
        .item-action {
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            flex: 1;
            min-width: 100px;
        }
        
        .action-edit {
            background-color: rgba(156, 39, 176, 0.1);
            color: #9c27b0;
            border: 1px solid rgba(156, 39, 176, 0.2);
        }
        
        .action-change {
            background-color: rgba(33, 150, 243, 0.1);
            color: var(--info-color);
            border: 1px solid rgba(33, 150, 243, 0.2);
        }
        
        .action-metamorphosis {
            background-color: rgba(255, 87, 34, 0.1);
            color: #ff5722;
            border: 1px solid rgba(255, 87, 34, 0.2);
        }
        
        .action-sale {
            background-color: rgba(103, 58, 183, 0.1);
            color: #673ab7;
            border: 1px solid rgba(103, 58, 183, 0.2);
        }
        
        .action-history {
            background-color: rgba(96, 125, 139, 0.1);
            color: #607d8b;
            border: 1px solid rgba(96, 125, 139, 0.2);
        }
        
        .action-delete {
            background-color: rgba(244, 67, 54, 0.1);
            color: var(--danger-color);
            border: 1px solid rgba(244, 67, 54, 0.2);
        }
        
        /* 空状态 */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-light);
        }
        
        .empty-state i {
            font-size: 3.5rem;
            margin-bottom: 20px;
            color: #e0f2e0;
            display: block;
        }
        
        .empty-state p {
            font-size: 1.1rem;
            font-weight: 500;
        }
        
        /* 销售记录卡片 */
        .sale-item {
            background-color: var(--card-color);
            border-radius: 15px;
            padding: 20px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(103, 58, 183, 0.1);
            margin-bottom: 15px;
            position: relative;
        }
        
        .sale-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
            background: linear-gradient(to bottom, #673ab7, #512da8);
            border-radius: 5px 0 0 5px;
        }
        
        /* 提醒卡片 */
        .reminder-item {
            background-color: var(--card-color);
            border-radius: 15px;
            padding: 20px;
            box-shadow: var(--shadow);
            border-left: 5px solid var(--warning-color);
            margin-bottom: 15px;
        }
        
        .reminder-item.danger {
            border-left-color: var(--danger-color);
        }
        
        .reminder-item.upcoming {
            border-left-color: var(--success-color);
        }
        
        /* 模态框 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease;
            padding: 15px;
        }
        
        .modal-content {
            background-color: var(--card-color);
            border-radius: 20px;
            width: 100%;
            max-width: 500px;
            padding: 25px;
            box-shadow: var(--shadow-heavy);
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(to right, var(--secondary-color), var(--primary-color));
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 1.4rem;
            color: var(--primary-color);
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            color: var(--text-light);
            transition: color 0.3s;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close-modal:active {
            background-color: rgba(244, 67, 54, 0.05);
        }
        
        /* 底部 */
        .footer {
            text-align: center;
            padding: 25px 15px;
            color: var(--text-light);
            font-size: 0.9rem;
            border-top: 1px solid var(--border-color);
            background-color: #f9fdf9;
        }
        
        /* 工具提示 */
        .tooltip {
            position: relative;
            display: inline-block;
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 280px;
            background-color: var(--accent-color);
            color: white;
            text-align: left;
            border-radius: 10px;
            padding: 12px;
            position: absolute;
            z-index: 1001;
            bottom: 125%;
            left: 50%;
            margin-left: -140px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.85rem;
            font-weight: normal;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            border: 1px solid var(--secondary-color);
        }
        
        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 8px;
            border-style: solid;
            border-color: var(--accent-color) transparent transparent transparent;
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        
        /* 响应式调整 */
        @media (min-width: 768px) {
            .form-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .item-details {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .stats {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        @media (min-width: 1024px) {
            .form-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .item-details {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        /* 滚动条美化 */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f8e9;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #c8e6c9;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #a5d6a7;
        }
        
        /* 动画效果 */
        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .slide-up {
            animation: slideUp 0.4s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 头部 -->
        <header class="header">
            <div class="logo-container">
                <div class="logo">
                    <i class="fas fa-bug"></i>
                </div>
                <div class="title-area">
                    <h1 class="title">甲虫库存管理工具</h1>
                    <div class="brand">wenbin出品</div>
                </div>
            </div>
            
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-title"><i class="fas fa-bug"></i> 总库存</div>
                    <div class="stat-value" id="total-count">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title"><i class="fas fa-yen-sign"></i> 总价值</div>
                    <div class="stat-value" id="total-value">¥0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title"><i class="fas fa-seedling"></i> 需换土</div>
                    <div class="stat-value" id="need-change">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title"><i class="fas fa-money-bill-wave"></i> 总销售</div>
                    <div class="stat-value" id="total-sales">¥0</div>
                </div>
            </div>
        </header>
        
        <!-- 标签导航 -->
        <div class="tabs-container">
            <div class="tabs">
                <button class="tab active" data-tab="inventory">
                    <i class="fas fa-boxes"></i> 库存
                </button>
                <button class="tab" data-tab="sales">
                    <i class="fas fa-chart-line"></i> 销售
                </button>
                <button class="tab" data-tab="reminders">
                    <i class="fas fa-bell"></i> 提醒
                </button>
                <button class="tab" data-tab="data">
                    <i class="fas fa-database"></i> 数据
                </button>
            </div>
        </div>
        
        <!-- 内容区域 -->
        <div class="content">
            <!-- 库存管理标签 -->
            <div class="tab-content active" id="inventory-tab">
                <!-- 新增库存项目卡片 -->
                <div class="card slide-up">
                    <h2 class="card-title"><i class="fas fa-plus-circle"></i> 新增库存项目</h2>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="item-name"><i class="fas fa-tag"></i> 品名 *</label>
                            <input type="text" id="item-name" placeholder="例如：彩虹锹形虫">
                            <div class="input-hint">新品名将自动添加到选单</div>
                        </div>
                        
                        <div class="form-group">
                            <label for="item-subcategory"><i class="fas fa-filter"></i> 子分类</label>
                            <input type="text" id="item-subcategory" placeholder="例如：红色型、蓝色型">
                        </div>
                        
                        <div class="form-group">
                            <label for="item-size"><i class="fas fa-ruler"></i> 尺寸 (mm)</label>
                            <input type="text" id="item-size" placeholder="例如：70-85 或 L1/L2">
                        </div>
                        
                        <div class="form-group">
                            <label for="item-gender"><i class="fas fa-venus-mars"></i> 性别/阶段 *</label>
                            <select id="item-gender">
                                <option value="">选择性别/阶段</option>
                                <option value="公">公</option>
                                <option value="母">母</option>
                                <option value="幼虫">幼虫</option>
                                <option value="蛹">蛹</option>
                                <option value="未知">未知</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="item-quantity"><i class="fas fa-hashtag"></i> 数量 *</label>
                            <input type="number" id="item-quantity" min="1" value="1">
                        </div>
                        
                        <div class="form-group">
                            <label for="item-price"><i class="fas fa-yen-sign"></i> 单价 (¥)</label>
                            <input type="number" id="item-price" min="0" step="0.01" placeholder="例如：150.00">
                        </div>
                        
                        <div class="form-group">
                            <label for="item-change-date"><i class="fas fa-calendar-day"></i> 最近换土时间</label>
                            <input type="date" id="item-change-date">
                            <div class="input-hint">仅幼虫/蛹需要</div>
                        </div>
                    </div>
                    
                    <div class="button-group">
                        <button id="add-item" class="btn-primary">
                            <i class="fas fa-plus"></i> 新增项目
                        </button>
                        <button id="clear-form" class="btn-secondary">
                            <i class="fas fa-eraser"></i> 清空
                        </button>
                        <button id="auto-fill-date" class="btn-info">
                            <i class="fas fa-calendar-alt"></i> 自动填充
                        </button>
                    </div>
                </div>
                
                <!-- 库存列表 -->
                <div class="card slide-up">
                    <h2 class="card-title"><i class="fas fa-list"></i> 库存列表</h2>
                    
                    <div id="inventory-list" class="inventory-list">
                        <!-- 库存项目将通过JavaScript动态添加 -->
                    </div>
                    
                    <div id="empty-inventory" class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <p>暂无库存数据，请添加新的甲虫项目</p>
                    </div>
                </div>
            </div>
            
            <!-- 销售记录标签 -->
            <div class="tab-content" id="sales-tab">
                <div class="card slide-up">
                    <h2 class="card-title"><i class="fas fa-money-bill-wave"></i> 销售记录</h2>
                    
                    <div id="sales-list">
                        <!-- 销售记录将通过JavaScript动态添加 -->
                    </div>
                    
                    <div id="empty-sales" class="empty-state">
                        <i class="fas fa-chart-bar"></i>
                        <p>暂无销售记录</p>
                    </div>
                    
                    <div class="button-group" style="margin-top: 20px;">
                        <button id="clear-sales" class="btn-danger">
                            <i class="fas fa-trash-alt"></i> 清空销售记录
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 换土提醒标签 -->
            <div class="tab-content" id="reminders-tab">
                <div class="card slide-up">
                    <h2 class="card-title"><i class="fas fa-bell"></i> 换土提醒</h2>
                    
                    <div id="reminders-list">
                        <!-- 提醒将通过JavaScript动态添加 -->
                    </div>
                    
                    <div id="empty-reminders" class="empty-state">
                        <i class="fas fa-bell-slash"></i>
                        <p>暂无换土提醒</p>
                    </div>
                </div>
            </div>
            
            <!-- 数据管理标签 -->
            <div class="tab-content" id="data-tab">
                <div class="card slide-up">
                    <h2 class="card-title"><i class="fas fa-database"></i> 数据管理</h2>
                    
                    <div class="info-card" style="background-color: #f0f9f0; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                        <p style="color: var(--text-color); font-size: 0.95rem;">
                            <i class="fas fa-info-circle"></i> 数据默认保存在浏览器本地存储中。建议定期备份以防数据丢失。
                        </p>
                    </div>
                    
                    <div class="button-group">
                        <button id="save-local" class="btn-primary">
                            <i class="fas fa-save"></i> 保存数据
                        </button>
                        <button id="load-local" class="btn-secondary">
                            <i class="fas fa-folder-open"></i> 加载数据
                        </button>
                    </div>
                    
                    <div class="button-group" style="margin-top: 15px;">
                        <button id="export-json" class="btn-secondary">
                            <i class="fas fa-file-export"></i> 导出JSON
                        </button>
                        <button id="import-json" class="btn-secondary">
                            <i class="fas fa-file-import"></i> 导入JSON
                        </button>
                        <button id="clear-data" class="btn-danger">
                            <i class="fas fa-trash-alt"></i> 清空数据
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 页脚 -->
        <footer class="footer">
            <p>甲虫库存管理工具 &copy; <span id="current-year">2023</span> | wenbin出品</p>
            <p style="margin-top: 10px; font-size: 0.85rem; color: var(--text-light);">
                <i class="fas fa-lock"></i> 数据本地存储，不上传服务器
            </p>
        </footer>
    </div>

    <!-- 模态框模板 -->
    <div id="modal-template" style="display: none;">
        <div class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title"></h3>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="modal-body"></div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 设置当前年份
            document.getElementById('current-year').textContent = new Date().getFullYear();
            
            // 初始化数据
            let inventory = JSON.parse(localStorage.getItem('beetle-inventory')) || [];
            let sales = JSON.parse(localStorage.getItem('beetle-sales')) || [];
            let itemNames = JSON.parse(localStorage.getItem('beetle-item-names')) || [];
            let subcategories = JSON.parse(localStorage.getItem('beetle-subcategories')) || {};
            
            // 当前打开的模态框ID
            let currentModalItemId = null;
            
            // 标签切换功能
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    // 移除所有标签的active类
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    // 为当前标签添加active类
                    this.classList.add('active');
                    
                    // 显示对应的内容
                    const tabId = this.getAttribute('data-tab');
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                    
                    // 如果是提醒标签，刷新提醒列表
                    if (tabId === 'reminders') {
                        updateReminders();
                    }
                    
                    // 如果是销售标签，刷新销售记录
                    if (tabId === 'sales') {
                        renderSalesList();
                        updateSalesStats();
                    }
                });
            });
            
            // 检查是否需要换土
            function needsSoilChange(gender) {
                // 成虫（公、母）不需要换土，幼虫、蛹、未知需要
                return gender !== '公' && gender !== '母';
            }
            
            // 获取性别对应的CSS类
            function getGenderClass(gender) {
                if (gender === '公' || gender === '母') {
                    return 'gender-adult';
                } else if (gender === '幼虫') {
                    return 'gender-larva';
                } else if (gender === '蛹') {
                    return 'gender-pupa';
                }
                return '';
            }
            
            // 获取状态文本和类
            function getStatusInfo(item) {
                // 成虫不需要换土
                if (!needsSoilChange(item.gender)) {
                    return {
                        text: '成虫（无需换土）',
                        class: 'status-active'
                    };
                }
                
                // 幼虫/蛹但没有设置换土时间
                if (!item.nextChangeDate) {
                    return {
                        text: '未设置换土时间',
                        class: 'status-warning'
                    };
                }
                
                const changeDateObj = new Date(item.nextChangeDate);
                const today = new Date();
                const diffTime = changeDateObj - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                if (diffDays < 0) {
                    return {
                        text: '已超期',
                        class: 'status-danger'
                    };
                } else if (diffDays <= 3) {
                    return {
                        text: '需立即换土',
                        class: 'status-danger'
                    };
                } else if (diffDays <= 7) {
                    return {
                        text: '近期需换土',
                        class: 'status-warning'
                    };
                } else if (diffDays <= 30) {
                    return {
                        text: '正常',
                        class: 'status-active'
                    };
                } else {
                    return {
                        text: '正常',
                        class: 'status-active'
                    };
                }
            }
            
            // 更新统计数据
            function updateStats() {
                let totalCount = 0;
                let totalValue = 0;
                let needChangeCount = 0;
                const today = new Date();
                const nextWeek = new Date();
                nextWeek.setDate(today.getDate() + 7);
                
                inventory.forEach(item => {
                    totalCount += item.quantity;
                    totalValue += item.quantity * item.price;
                    
                    // 检查是否需要换土
                    if (needsSoilChange(item.gender) && item.nextChangeDate) {
                        const nextChangeDate = new Date(item.nextChangeDate);
                        if (nextChangeDate <= nextWeek) {
                            needChangeCount++;
                        }
                    }
                });
                
                document.getElementById('total-count').textContent = totalCount;
                document.getElementById('total-value').textContent = '¥' + totalValue.toFixed(2);
                document.getElementById('need-change').textContent = needChangeCount;
                
                // 更新销售统计
                updateSalesStats();
            }
            
            // 更新销售统计
            function updateSalesStats() {
                let totalSalesAmount = 0;
                
                sales.forEach(sale => {
                    totalSalesAmount += sale.totalPrice;
                });
                
                document.getElementById('total-sales').textContent = '¥' + totalSalesAmount.toFixed(2);
            }
            
            // 显示库存列表（移动端优化）
            function renderInventoryList() {
                const container = document.getElementById('inventory-list');
                const emptyMsg = document.getElementById('empty-inventory');
                
                if (inventory.length === 0) {
                    container.innerHTML = '';
                    emptyMsg.style.display = 'block';
                    updateStats();
                    return;
                }
                
                emptyMsg.style.display = 'none';
                
                // 按品名分组
                const groupedItems = {};
                inventory.forEach(item => {
                    if (!groupedItems[item.name]) {
                        groupedItems[item.name] = [];
                    }
                    groupedItems[item.name].push(item);
                });
                
                // 按品名排序
                const sortedNames = Object.keys(groupedItems).sort();
                
                let listHTML = '';
                
                sortedNames.forEach(name => {
                    // 添加品名分组标题
                    listHTML += `
                    <div class="category-header" style="margin: 20px 0 10px; padding-left: 10px; border-left: 4px solid var(--secondary-color);">
                        <h3 style="color: var(--primary-color); font-size: 1.2rem;">${name}</h3>
                    </div>
                    `;
                    
                    // 添加该品名下的所有项目
                    groupedItems[name].forEach((item, index) => {
                        const totalPrice = item.quantity * item.price;
                        const genderClass = getGenderClass(item.gender);
                        const statusInfo = getStatusInfo(item);
                        
                        // 检查是否为羽化生成的成虫
                        let metamorphosisNote = '';
                        if (item.metamorphosisFrom) {
                            metamorphosisNote = `<span style="display: inline-block; background: linear-gradient(135deg, #ff9800, #ff5722); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; margin-left: 5px; font-weight: 600;">羽化</span>`;
                        }
                        
                        // 历史记录徽章
                        let historyBadge = '';
                        if (item.changeHistory && item.changeHistory.length > 0) {
                            const larvaHistoryCount = item.changeHistory.filter(record => 
                                !record.notes || !record.notes.includes('羽化记录')
                            ).length;
                            
                            if (larvaHistoryCount > 0) {
                                historyBadge = `<span class="tooltip" title="${larvaHistoryCount}条换土历史记录" style="display: inline-block; background-color: #e8f5e9; color: var(--primary-color); padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; margin-left: 5px; font-weight: 600;">
                                    <i class="fas fa-history"></i> ${larvaHistoryCount}
                                </span>`;
                            }
                        }
                        
                        listHTML += `
                        <div class="inventory-item slide-up" data-id="${item.id}">
                            <div class="item-header">
                                <div>
                                    <div class="item-name">${item.name}${metamorphosisNote}</div>
                                    ${item.subcategory ? `<div class="item-subcategory">${item.subcategory}</div>` : ''}
                                </div>
                                <span class="item-status ${statusInfo.class}">${statusInfo.text}</span>
                            </div>
                            
                            <div class="item-details">
                                <div class="detail-item">
                                    <span class="detail-label">尺寸</span>
                                    <span class="detail-value">${item.size || '-'}</span>
                                </div>
                                
                                <div class="detail-item">
                                    <span class="detail-label">性别/阶段</span>
                                    <span class="detail-value ${genderClass}">${item.gender || '-'} ${historyBadge}</span>
                                </div>
                                
                                <div class="detail-item">
                                    <span class="detail-label">数量</span>
                                    <span class="detail-value">${item.quantity}</span>
                                </div>
                                
                                <div class="detail-item">
                                    <span class="detail-label">单价</span>
                                    <span class="detail-value">¥${item.price.toFixed(2)}</span>
                                </div>
                                
                                <div class="detail-item">
                                    <span class="detail-label">总价</span>
                                    <span class="detail-value">¥${totalPrice.toFixed(2)}</span>
                                </div>
                                
                                <div class="detail-item">
                                    <span class="detail-label">下次换土</span>
                                    <span class="detail-value">${item.nextChangeDate || '-'}</span>
                                </div>
                            </div>
                            
                            <div class="item-footer">
                                <button class="item-action action-edit edit-item" data-id="${item.id}">
                                    <i class="fas fa-edit"></i> 编辑
                                </button>
                                
                                ${needsSoilChange(item.gender) ? `
                                <button class="item-action action-change record-soil-change" data-id="${item.id}">
                                    <i class="fas fa-seedling"></i> 换土
                                </button>
                                ` : ''}
                                
                                ${item.gender === '幼虫' && item.quantity > 0 ? `
                                <button class="item-action action-metamorphosis record-metamorphosis" data-id="${item.id}">
                                    <i class="fas fa-bug"></i> 羽化
                                </button>
                                ` : ''}
                                
                                ${item.quantity > 0 ? `
                                <button class="item-action action-sale record-sale" data-id="${item.id}">
                                    <i class="fas fa-money-bill-wave"></i> 售卖
                                </button>
                                ` : ''}
                                
                                ${item.changeHistory && item.changeHistory.length > 0 ? `
                                <button class="item-action action-history view-history" data-id="${item.id}">
                                    <i class="fas fa-history"></i> 历史
                                </button>
                                ` : ''}
                                
                                <button class="item-action action-delete delete-item" data-id="${item.id}">
                                    <i class="fas fa-trash"></i> 删除
                                </button>
                            </div>
                        </div>
                        `;
                    });
                });
                
                container.innerHTML = listHTML;
                updateStats();
                
                // 重新绑定按钮事件
                bindItemEvents();
            }
            
            // 绑定库存项目事件
            function bindItemEvents() {
                // 编辑项目
                document.querySelectorAll('.edit-item').forEach(button => {
                    button.addEventListener('click', function() {
                        const id = this.getAttribute('data-id');
                        openEditModal(id);
                    });
                });
                
                // 记录换土
                document.querySelectorAll('.record-soil-change').forEach(button => {
                    button.addEventListener('click', function() {
                        const id = this.getAttribute('data-id');
                        openSoilChangeModal(id);
                    });
                });
                
                // 幼虫羽化
                document.querySelectorAll('.record-metamorphosis').forEach(button => {
                    button.addEventListener('click', function() {
                        const id = this.getAttribute('data-id');
                        openMetamorphosisModal(id);
                    });
                });
                
                // 售卖
                document.querySelectorAll('.record-sale').forEach(button => {
                    button.addEventListener('click', function() {
                        const id = this.getAttribute('data-id');
                        openSaleModal(id);
                    });
                });
                
                // 查看历史
                document.querySelectorAll('.view-history').forEach(button => {
                    button.addEventListener('click', function() {
                        const id = this.getAttribute('data-id');
                        openHistoryModal(id);
                    });
                });
                
                // 删除项目
                document.querySelectorAll('.delete-item').forEach(button => {
                    button.addEventListener('click', function() {
                        const id = this.getAttribute('data-id');
                        deleteItem(id);
                    });
                });
            }
            
            // 显示销售列表
            function renderSalesList() {
                const container = document.getElementById('sales-list');
                const emptyMsg = document.getElementById('empty-sales');
                
                if (sales.length === 0) {
                    container.innerHTML = '';
                    emptyMsg.style.display = 'block';
                    return;
                }
                
                emptyMsg.style.display = 'none';
                
                // 按售出日期分组并排序
                const groupedSales = {};
                sales.forEach(sale => {
                    const saleDate = sale.date;
                    if (!groupedSales[saleDate]) {
                        groupedSales[saleDate] = [];
                    }
                    groupedSales[saleDate].push(sale);
                });
                
                // 按售出日期排序（最新的在前面）
                const sortedDates = Object.keys(groupedSales).sort((a, b) => {
                    return new Date(b) - new Date(a);
                });
                
                let listHTML = '';
                
                sortedDates.forEach(date => {
                    // 添加日期分组标题
                    listHTML += `
                    <div class="category-header" style="margin: 20px 0 10px; padding-left: 10px; border-left: 4px solid #673ab7;">
                        <h3 style="color: #673ab7; font-size: 1.2rem;">${date}</h3>
                    </div>
                    `;
                    
                    // 添加该日期下的所有销售记录
                    const dateSales = groupedSales[date];
                    dateSales.forEach((sale, index) => {
                        const genderClass = getGenderClass(sale.gender);
                        
                        listHTML += `
                        <div class="sale-item slide-up" data-id="${sale.id}">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                                <div>
                                    <div style="font-size: 1.1rem; font-weight: 700; color: var(--text-color);">${sale.name}</div>
                                    ${sale.subcategory ? `<div style="font-size: 0.9rem; color: var(--text-light); margin-top: 2px;">${sale.subcategory}</div>` : ''}
                                </div>
                                <div style="font-size: 1.2rem; font-weight: 700; color: #673ab7;">¥${sale.totalPrice.toFixed(2)}</div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px;">
                                <div>
                                    <div style="font-size: 0.85rem; color: var(--text-light);">尺寸</div>
                                    <div style="font-weight: 600;">${sale.size || '-'}</div>
                                </div>
                                
                                <div>
                                    <div style="font-size: 0.85rem; color: var(--text-light);">性别/阶段</div>
                                    <div style="font-weight: 600;" class="${genderClass}">${sale.gender || '-'}</div>
                                </div>
                                
                                <div>
                                    <div style="font-size: 0.85rem; color: var(--text-light);">数量</div>
                                    <div style="font-weight: 600;">${sale.quantity}</div>
                                </div>
                                
                                <div>
                                    <div style="font-size: 0.85rem; color: var(--text-light);">单价</div>
                                    <div style="font-weight: 600;">¥${sale.price.toFixed(2)}</div>
                                </div>
                            </div>
                            
                            ${sale.notes ? `<div style="font-size: 0.9rem; color: var(--text-light); padding: 8px; background-color: #f9f9f9; border-radius: 8px; margin-bottom: 10px;">${sale.notes}</div>` : ''}
                            
                            <div style="display: flex; justify-content: flex-end;">
                                <button class="item-action action-delete delete-sale" data-id="${sale.id}" style="flex: 0 0 auto;">
                                    <i class="fas fa-trash"></i> 删除
                                </button>
                            </div>
                        </div>
                        `;
                    });
                });
                
                container.innerHTML = listHTML;
                
                // 绑定删除销售记录事件
                document.querySelectorAll('.delete-sale').forEach(button => {
                    button.addEventListener('click', function() {
                        const id = this.getAttribute('data-id');
                        deleteSale(id);
                    });
                });
            }
            
            // 更新换土提醒列表
            function updateReminders() {
                const container = document.getElementById('reminders-list');
                const emptyMsg = document.getElementById('empty-reminders');
                const today = new Date();
                const fiveDaysLater = new Date();
                fiveDaysLater.setDate(today.getDate() + 5);
                const nextWeek = new Date();
                nextWeek.setDate(today.getDate() + 7);
                
                // 筛选需要提醒的项目（仅幼虫、蛹、未知，且需要换土的）
                const reminders = inventory.filter(item => {
                    // 只检查需要换土的项目
                    if (!needsSoilChange(item.gender)) return false;
                    
                    // 如果有下次换土时间
                    if (item.nextChangeDate) {
                        return true;
                    }
                    
                    return false;
                });
                
                // 按下次换土时间排序
                reminders.sort((a, b) => {
                    return new Date(a.nextChangeDate) - new Date(b.nextChangeDate);
                });
                
                // 分离出urgentReminders（7天内）和upcomingReminders（5天后）
                const urgentReminders = [];
                const upcomingReminders = [];
                
                reminders.forEach(item => {
                    const nextChangeDate = new Date(item.nextChangeDate);
                    const diffTime = nextChangeDate - today;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    
                    if (diffDays <= 7) {
                        urgentReminders.push(item);
                    } else if (diffDays <= 30) {
                        // 一个月内的提醒
                        upcomingReminders.push(item);
                    }
                });
                
                let listHTML = '';
                
                // 紧急提醒（7天内）
                if (urgentReminders.length > 0) {
                    listHTML += `
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: var(--primary-color); margin-bottom: 10px; font-size: 1.1rem;">
                            <i class="fas fa-exclamation-triangle"></i> 紧急提醒（7天内需换土）
                        </h3>
                    `;
                    
                    urgentReminders.forEach(item => {
                        const nextChangeDate = new Date(item.nextChangeDate);
                        const diffTime = nextChangeDate - today;
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        
                        let reminderClass = 'reminder-item';
                        if (diffDays < 0) {
                            reminderClass += ' danger';
                        } else if (diffDays <= 3) {
                            reminderClass += ' danger';
                        }
                        
                        const daysText = diffDays < 0 ? `超期 ${Math.abs(diffDays)} 天` : `剩余 ${diffDays} 天`;
                        
                        listHTML += `
                        <div class="${reminderClass}">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                                <div>
                                    <div style="font-size: 1.1rem; font-weight: 700;">${item.name}</div>
                                    ${item.subcategory ? `<div style="font-size: 0.9rem; color: var(--text-light);">${item.subcategory}</div>` : ''}
                                </div>
                                <div style="background-color: ${diffDays < 0 ? '#f44336' : diffDays <= 3 ? '#f44336' : '#ff9800'}; color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.85rem; font-weight: 600;">${daysText}</div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px;">
                                <div>
                                    <div style="font-size: 0.85rem; color: var(--text-light);">尺寸</div>
                                    <div style="font-weight: 600;">${item.size || '-'}</div>
                                </div>
                                
                                <div>
                                    <div style="font-size: 0.85rem; color: var(--text-light);">性别/阶段</div>
                                    <div style="font-weight: 600;" class="${getGenderClass(item.gender)}">${item.gender || '-'}</div>
                                </div>
                                
                                <div>
                                    <div style="font-size: 0.85rem; color: var(--text-light);">数量</div>
                                    <div style="font-weight: 600;">${item.quantity}</div>
                                </div>
                                
                                <div>
                                    <div style="font-size: 0.85rem; color: var(--text-light);">下次换土</div>
                                    <div style="font-weight: 600;">${item.nextChangeDate}</div>
                                </div>
                            </div>
                            
                            <div style="display: flex; justify-content: flex-end;">
                                <button class="item-action action-change record-soil-change" data-id="${item.id}" style="flex: 0 0 auto;">
                                    <i class="fas fa-seedling"></i> 记录换土
                                </button>
                            </div>
                        </div>
                        `;
                    });
                    
                    listHTML += `</div>`;
                }
                
                // 近期提醒（一个月内）
                if (upcomingReminders.length > 0) {
                    listHTML += `
                    <div>
                        <h3 style="color: var(--primary-color); margin-bottom: 10px; font-size: 1.1rem;">
                            <i class="fas fa-calendar-check"></i> 近期提醒（一个月内需换土）
                        </h3>
                    `;
                    
                    upcomingReminders.forEach(item => {
                        const nextChangeDate = new Date(item.nextChangeDate);
                        const diffTime = nextChangeDate - today;
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        
                        listHTML += `
                        <div class="reminder-item upcoming">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                                <div>
                                    <div style="font-size: 1.1rem; font-weight: 700;">${item.name}</div>
                                    ${item.subcategory ? `<div style="font-size: 0.9rem; color: var(--text-light);">${item.subcategory}</div>` : ''}
                                </div>
                                <div style="background-color: #4caf50; color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.85rem; font-weight: 600;">剩余 ${diffDays} 天</div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 10px;">
                                <div>
                                    <div style="font-size: 0.85rem; color: var(--text-light);">性别/阶段</div>
                                    <div style="font-weight: 600;" class="${getGenderClass(item.gender)}">${item.gender || '-'}</div>
                                </div>
                                
                                <div>
                                    <div style="font-size: 0.85rem; color: var(--text-light);">数量</div>
                                    <div style="font-weight: 600;">${item.quantity}</div>
                                </div>
                                
                                <div>
                                    <div style="font-size: 0.85rem; color: var(--text-light);">下次换土</div>
                                    <div style="font-weight: 600;">${item.nextChangeDate}</div>
                                </div>
                            </div>
                        </div>
                        `;
                    });
                    
                    listHTML += `</div>`;
                }
                
                if (urgentReminders.length === 0 && upcomingReminders.length === 0) {
                    container.innerHTML = '';
                    emptyMsg.style.display = 'block';
                } else {
                    container.innerHTML = listHTML;
                    emptyMsg.style.display = 'none';
                    
                    // 绑定提醒列表中的按钮事件
                    document.querySelectorAll('#reminders-list .record-soil-change').forEach(button => {
                        button.addEventListener('click', function() {
                            const id = this.getAttribute('data-id');
                            openSoilChangeModal(id);
                        });
                    });
                }
            }
            
            // 生成唯一ID
            function generateId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            }
            
            // 计算三个月后的日期
            function calculateThreeMonthsLater(date) {
                const result = new Date(date);
                result.setMonth(result.getMonth() + 3);
                return result.toISOString().split('T')[0];
            }
            
            // 添加新项目
            function addItem() {
                const name = document.getElementById('item-name').value.trim();
                const subcategory = document.getElementById('item-subcategory').value.trim();
                const size = document.getElementById('item-size').value.trim();
                const gender = document.getElementById('item-gender').value;
                const quantity = parseInt(document.getElementById('item-quantity').value) || 1;
                const price = parseFloat(document.getElementById('item-price').value) || 0;
                const changeDate = document.getElementById('item-change-date').value;
                
                // 验证必填项
                if (!name) {
                    alert('请填写品名');
                    document.getElementById('item-name').focus();
                    return;
                }
                
                if (!gender) {
                    alert('请选择性别/阶段');
                    document.getElementById('item-gender').focus();
                    return;
                }
                
                // 添加到品名列表（如果不存在）
                if (!itemNames.includes(name)) {
                    itemNames.push(name);
                    localStorage.setItem('beetle-item-names', JSON.stringify(itemNames));
                }
                
                // 更新子分类列表
                if (subcategory) {
                    updateSubcategories(name, subcategory);
                }
                
                // 检查是否需要换土
                const needsChange = needsSoilChange(gender);
                
                // 设置换土时间（仅幼虫、蛹、未知需要）
                let lastChangeDate = '';
                let nextChangeDate = '';
                let changeHistory = [];
                
                if (needsChange) {
                    if (changeDate) {
                        lastChangeDate = changeDate;
                        nextChangeDate = calculateThreeMonthsLater(lastChangeDate);
                        changeHistory = [{
                            date: lastChangeDate,
                            notes: '初始记录'
                        }];
                    } else {
                        // 如果没有提供换土时间，使用今天作为默认
                        const today = new Date().toISOString().split('T')[0];
                        lastChangeDate = today;
                        nextChangeDate = calculateThreeMonthsLater(today);
                        changeHistory = [{
                            date: today,
                            notes: '初始记录'
                        }];
                    }
                }
                
                // 创建新项目
                const newItem = {
                    id: generateId(),
                    name: name,
                    subcategory: subcategory || '',
                    size: size,
                    gender: gender,
                    quantity: quantity,
                    price: price,
                    lastChangeDate: lastChangeDate,
                    nextChangeDate: nextChangeDate,
                    changeHistory: changeHistory,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    metamorphosisFrom: null,
                    larvaHistoryPreserved: false
                };
                
                inventory.push(newItem);
                localStorage.setItem('beetle-inventory', JSON.stringify(inventory));
                
                // 清空表单
                clearForm();
                
                // 更新列表
                renderInventoryList();
                updateReminders();
                
                // 显示成功消息
                alert('项目添加成功！' + (needsChange && !changeDate ? '\n注意：已自动设置换土时间为今天。' : ''));
            }
            
            // 删除项目
            function deleteItem(id) {
                if (confirm('确定要删除这个项目吗？')) {
                    inventory = inventory.filter(item => item.id !== id);
                    localStorage.setItem('beetle-inventory', JSON.stringify(inventory));
                    renderInventoryList();
                    updateReminders();
                }
            }
            
            // 删除销售记录
            function deleteSale(id) {
                if (confirm('确定要删除这条销售记录吗？')) {
                    sales = sales.filter(sale => sale.id !== id);
                    localStorage.setItem('beetle-sales', JSON.stringify(sales));
                    renderSalesList();
                    updateSalesStats();
                    updateStats();
                }
            }
            
            // 清空表单
            function clearForm() {
                document.getElementById('item-name').value = '';
                document.getElementById('item-subcategory').value = '';
                document.getElementById('item-size').value = '';
                document.getElementById('item-gender').value = '';
                document.getElementById('item-quantity').value = '1';
                document.getElementById('item-price').value = '';
                document.getElementById('item-change-date').value = '';
            }
            
            // 自动填充换土时间
            document.getElementById('auto-fill-date').addEventListener('click', function() {
                const gender = document.getElementById('item-gender').value;
                if (!needsSoilChange(gender)) {
                    alert('成虫（公、母）不需要换土时间');
                    return;
                }
                
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('item-change-date').value = today;
                
                alert('已自动填充最近换土时间为今天');
            });
            
            // 打开售卖模态框
            function openSaleModal(id) {
                const item = inventory.find(item => item.id === id);
                if (!item) return;
                
                // 如果数量为0，不能进行售卖操作
                if (item.quantity <= 0) {
                    alert('该项目数量为0，无法售卖。');
                    return;
                }
                
                currentModalItemId = id;
                
                // 创建模态框
                const modalHTML = `
                <div class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title"><i class="fas fa-money-bill-wave"></i> 记录售卖</h3>
                            <button class="close-modal">&times;</button>
                        </div>
                        <div class="modal-body">
                            <p style="margin-bottom: 20px; font-weight: 600; font-size: 1.1rem; color: var(--text-color);">
                                ${item.name}${item.subcategory ? ` (${item.subcategory})` : ''} - ${item.size || '无尺寸'} - ${item.gender || '未知'}
                            </p>
                            
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="modal-sale-date"><i class="fas fa-calendar-day"></i> 售出日期</label>
                                    <input type="date" id="modal-sale-date" value="${new Date().toISOString().split('T')[0]}">
                                </div>
                                
                                <div class="form-group">
                                    <label for="modal-sale-quantity"><i class="fas fa-hashtag"></i> 售出数量</label>
                                    <input type="number" id="modal-sale-quantity" min="1" max="${item.quantity}" value="1">
                                    <div class="input-hint">库存数量: ${item.quantity}</div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="modal-sale-price"><i class="fas fa-yen-sign"></i> 售出单价 (¥)</label>
                                    <input type="number" id="modal-sale-price" min="0" step="0.01" value="${item.price}">
                                    <div class="input-hint">原价: ¥${item.price.toFixed(2)}</div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="modal-sale-notes"><i class="fas fa-sticky-note"></i> 备注 (可选)</label>
                                    <input type="text" id="modal-sale-notes" placeholder="例如：售给王先生">
                                </div>
                            </div>
                            
                            <div class="button-group" style="margin-top: 30px;">
                                <button id="modal-save-sale" class="btn-primary" style="flex: 1;">
                                    <i class="fas fa-money-bill-wave"></i> 确认售卖
                                </button>
                                <button id="modal-cancel-sale" class="btn-secondary" style="flex: 1;">
                                    取消
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                `;
                
                // 添加模态框到页面
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                
                // 显示模态框
                const modal = document.querySelector('.modal:last-child');
                modal.style.display = 'flex';
                
                // 绑定事件
                modal.querySelector('.close-modal').addEventListener('click', () => {
                    modal.remove();
                    currentModalItemId = null;
                });
                
                modal.querySelector('#modal-cancel-sale').addEventListener('click', () => {
                    modal.remove();
                    currentModalItemId = null;
                });
                
                modal.querySelector('#modal-save-sale').addEventListener('click', saveSale);
                
                // 点击模态框外部关闭
                modal.addEventListener('click', function(event) {
                    if (event.target === this) {
                        modal.remove();
                        currentModalItemId = null;
                    }
                });
            }
            
            // 保存售卖记录
            function saveSale() {
                const saleDate = document.getElementById('modal-sale-date').value;
                const saleQuantity = parseInt(document.getElementById('modal-sale-quantity').value) || 0;
                const salePrice = parseFloat(document.getElementById('modal-sale-price').value) || 0;
                const saleNotes = document.getElementById('modal-sale-notes').value.trim();
                
                // 验证必填项
                if (!saleDate) {
                    alert('请选择售出日期');
                    document.getElementById('modal-sale-date').focus();
                    return;
                }
                
                if (saleQuantity <= 0) {
                    alert('售出数量必须大于0');
                    document.getElementById('modal-sale-quantity').focus();
                    return;
                }
                
                if (salePrice <= 0) {
                    alert('售出单价必须大于0');
                    document.getElementById('modal-sale-price').focus();
                    return;
                }
                
                // 查找项目
                const itemIndex = inventory.findIndex(item => item.id === currentModalItemId);
                if (itemIndex === -1) return;
                
                const item = inventory[itemIndex];
                
                // 验证库存数量
                if (saleQuantity > item.quantity) {
                    alert(`售出数量不能超过库存数量（当前库存：${item.quantity}）`);
                    document.getElementById('modal-sale-quantity').focus();
                    return;
                }
                
                // 计算总价
                const totalPrice = saleQuantity * salePrice;
                
                // 1. 创建销售记录
                const newSale = {
                    id: generateId(),
                    itemId: currentModalItemId,
                    date: saleDate,
                    name: item.name,
                    subcategory: item.subcategory || '',
                    size: item.size || '',
                    gender: item.gender,
                    quantity: saleQuantity,
                    price: salePrice,
                    totalPrice: totalPrice,
                    notes: saleNotes,
                    createdAt: new Date().toISOString()
                };
                
                // 添加到销售记录
                sales.push(newSale);
                localStorage.setItem('beetle-sales', JSON.stringify(sales));
                
                // 2. 更新库存
                if (saleQuantity === item.quantity) {
                    // 如果售出数量等于库存数量，从库存中移除该项目
                    inventory.splice(itemIndex, 1);
                } else {
                    // 否则减少库存数量
                    inventory[itemIndex].quantity -= saleQuantity;
                    inventory[itemIndex].updatedAt = new Date().toISOString();
                }
                
                localStorage.setItem('beetle-inventory', JSON.stringify(inventory));
                
                // 3. 关闭模态框
                document.querySelector('.modal:last-child').remove();
                currentModalItemId = null;
                
                // 4. 更新列表和统计
                renderInventoryList();
                renderSalesList();
                updateSalesStats();
                updateReminders();
                
                // 5. 显示成功消息
                alert(`售卖记录已保存！成功售出${saleQuantity}只${item.name}，总金额¥${totalPrice.toFixed(2)}。`);
            }
            
            // 打开记录换土模态框
            function openSoilChangeModal(id) {
                const item = inventory.find(item => item.id === id);
                if (!item) return;
                
                // 如果是成虫，不需要换土
                if (!needsSoilChange(item.gender)) {
                    alert('成虫（公、母）不需要换土，只需定期清洁和喂食即可。但会保留换土历史记录。');
                    return;
                }
                
                currentModalItemId = id;
                
                // 创建模态框
                const modalHTML = `
                <div class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title"><i class="fas fa-seedling"></i> 记录换土</h3>
                            <button class="close-modal">&times;</button>
                        </div>
                        <div class="modal-body">
                            <p style="margin-bottom: 20px; font-weight: 600; font-size: 1.1rem; color: var(--text-color);">
                                ${item.name}${item.subcategory ? ` (${item.subcategory})` : ''} - ${item.size || '无尺寸'} - ${item.gender || '未知'}
                            </p>
                            
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="modal-soil-date"><i class="fas fa-calendar-day"></i> 换土日期</label>
                                    <input type="date" id="modal-soil-date" value="${new Date().toISOString().split('T')[0]}">
                                </div>
                                
                                <div class="form-group">
                                    <label for="modal-soil-notes"><i class="fas fa-sticky-note"></i> 备注 (可选)</label>
                                    <input type="text" id="modal-soil-notes" placeholder="例如：更换新土，添加发酵木屑">
                                </div>
                            </div>
                            
                            <div class="button-group" style="margin-top: 30px;">
                                <button id="modal-save-soil" class="btn-primary" style="flex: 1;">
                                    <i class="fas fa-save"></i> 保存换土记录
                                </button>
                                <button id="modal-cancel-soil" class="btn-secondary" style="flex: 1;">
                                    取消
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                `;
                
                // 添加模态框到页面
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                
                // 显示模态框
                const modal = document.querySelector('.modal:last-child');
                modal.style.display = 'flex';
                
                // 绑定事件
                modal.querySelector('.close-modal').addEventListener('click', () => {
                    modal.remove();
                    currentModalItemId = null;
                });
                
                modal.querySelector('#modal-cancel-soil').addEventListener('click', () => {
                    modal.remove();
                    currentModalItemId = null;
                });
                
                modal.querySelector('#modal-save-soil').addEventListener('click', saveSoilChange);
                
                // 点击模态框外部关闭
                modal.addEventListener('click', function(event) {
                    if (event.target === this) {
                        modal.remove();
                        currentModalItemId = null;
                    }
                });
            }
            
            // 保存换土记录
            function saveSoilChange() {
                const changeDate = document.getElementById('modal-soil-date').value;
                const notes = document.getElementById('modal-soil-notes').value.trim();
                
                if (!changeDate) {
                    alert('请选择换土日期');
                    return;
                }
                
                const itemIndex = inventory.findIndex(item => item.id === currentModalItemId);
                if (itemIndex === -1) return;
                
                // 确保是需要换土的项目
                if (!needsSoilChange(inventory[itemIndex].gender)) {
                    alert('错误：成虫不需要换土！但换土历史记录会保留。');
                    document.querySelector('.modal:last-child').remove();
                    currentModalItemId = null;
                    return;
                }
                
                // 更新换土记录
                const nextChangeDate = calculateThreeMonthsLater(changeDate);
                
                inventory[itemIndex].lastChangeDate = changeDate;
                inventory[itemIndex].nextChangeDate = nextChangeDate;
                inventory[itemIndex].updatedAt = new Date().toISOString();
                
                // 添加换土历史记录
                if (!inventory[itemIndex].changeHistory) {
                    inventory[itemIndex].changeHistory = [];
                }
                
                inventory[itemIndex].changeHistory.push({
                    date: changeDate,
                    notes: notes || '换土记录'
                });
                
                // 保存到本地存储
                localStorage.setItem('beetle-inventory', JSON.stringify(inventory));
                
                // 关闭模态框
                document.querySelector('.modal:last-child').remove();
                currentModalItemId = null;
                
                // 更新列表和提醒
                renderInventoryList();
                updateReminders();
                
                alert('换土记录已保存！');
            }
            
            // 打开编辑项目模态框
            function openEditModal(id) {
                const item = inventory.find(item => item.id === id);
                if (!item) return;
                
                currentModalItemId = id;
                
                // 创建模态框
                const modalHTML = `
                <div class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title"><i class="fas fa-edit"></i> 编辑项目</h3>
                            <button class="close-modal">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="modal-edit-name"><i class="fas fa-tag"></i> 品名</label>
                                    <input type="text" id="modal-edit-name" value="${item.name}">
                                </div>
                                
                                <div class="form-group">
                                    <label for="modal-edit-subcategory"><i class="fas fa-filter"></i> 子分类</label>
                                    <input type="text" id="modal-edit-subcategory" value="${item.subcategory || ''}">
                                </div>
                                
                                <div class="form-group">
                                    <label for="modal-edit-size"><i class="fas fa-ruler"></i> 尺寸 (mm)</label>
                                    <input type="text" id="modal-edit-size" value="${item.size || ''}">
                                </div>
                                
                                <div class="form-group">
                                    <label for="modal-edit-gender"><i class="fas fa-venus-mars"></i> 性别/阶段</label>
                                    <select id="modal-edit-gender">
                                        <option value="公" ${item.gender === '公' ? 'selected' : ''}>公</option>
                                        <option value="母" ${item.gender === '母' ? 'selected' : ''}>母</option>
                                        <option value="幼虫" ${item.gender === '幼虫' ? 'selected' : ''}>幼虫</option>
                                        <option value="蛹" ${item.gender === '蛹' ? 'selected' : ''}>蛹</option>
                                        <option value="未知" ${item.gender === '未知' ? 'selected' : ''}>未知</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="modal-edit-quantity"><i class="fas fa-hashtag"></i> 数量</label>
                                    <input type="number" id="modal-edit-quantity" min="1" value="${item.quantity}">
                                </div>
                                
                                <div class="form-group">
                                    <label for="modal-edit-price"><i class="fas fa-yen-sign"></i> 单价 (¥)</label>
                                    <input type="number" id="modal-edit-price" min="0" step="0.01" value="${item.price}">
                                </div>
                            </div>
                            
                            <div class="button-group" style="margin-top: 30px;">
                                <button id="modal-save-edit" class="btn-primary" style="flex: 1;">
                                    <i class="fas fa-save"></i> 保存修改
                                </button>
                                <button id="modal-cancel-edit" class="btn-secondary" style="flex: 1;">
                                    取消
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                `;
                
                // 添加模态框到页面
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                
                // 显示模态框
                const modal = document.querySelector('.modal:last-child');
                modal.style.display = 'flex';
                
                // 绑定事件
                modal.querySelector('.close-modal').addEventListener('click', () => {
                    modal.remove();
                    currentModalItemId = null;
                });
                
                modal.querySelector('#modal-cancel-edit').addEventListener('click', () => {
                    modal.remove();
                    currentModalItemId = null;
                });
                
                modal.querySelector('#modal-save-edit').addEventListener('click', saveItemEdit);
                
                // 点击模态框外部关闭
                modal.addEventListener('click', function(event) {
                    if (event.target === this) {
                        modal.remove();
                        currentModalItemId = null;
                    }
                });
            }
            
            // 保存编辑
            function saveItemEdit() {
                const name = document.getElementById('modal-edit-name').value.trim();
                const subcategory = document.getElementById('modal-edit-subcategory').value.trim();
                const size = document.getElementById('modal-edit-size').value.trim();
                const gender = document.getElementById('modal-edit-gender').value;
                const quantity = parseInt(document.getElementById('modal-edit-quantity').value) || 1;
                const price = parseFloat(document.getElementById('modal-edit-price').value) || 0;
                
                // 验证必填项
                if (!name) {
                    alert('请填写品名');
                    document.getElementById('modal-edit-name').focus();
                    return;
                }
                
                if (!gender) {
                    alert('请选择性别/阶段');
                    document.getElementById('modal-edit-gender').focus();
                    return;
                }
                
                const itemIndex = inventory.findIndex(item => item.id === currentModalItemId);
                if (itemIndex === -1) return;
                
                // 检查是否需要换土
                const newNeedsChange = needsSoilChange(gender);
                const oldNeedsChange = needsSoilChange(inventory[itemIndex].gender);
                
                // 更新项目基本信息
                inventory[itemIndex].name = name;
                inventory[itemIndex].subcategory = subcategory || '';
                inventory[itemIndex].size = size;
                inventory[itemIndex].gender = gender;
                inventory[itemIndex].quantity = quantity;
                inventory[itemIndex].price = price;
                inventory[itemIndex].updatedAt = new Date().toISOString();
                
                // 处理换土时间（如果从成虫变为幼虫/蛹，需要初始化换土时间）
                if (newNeedsChange && !oldNeedsChange && !inventory[itemIndex].lastChangeDate) {
                    const today = new Date().toISOString().split('T')[0];
                    inventory[itemIndex].lastChangeDate = today;
                    inventory[itemIndex].nextChangeDate = calculateThreeMonthsLater(today);
                    
                    if (!inventory[itemIndex].changeHistory) {
                        inventory[itemIndex].changeHistory = [];
                    }
                    
                    inventory[itemIndex].changeHistory.push({
                        date: today,
                        notes: '初始记录'
                    });
                }
                
                // 保存到本地存储
                localStorage.setItem('beetle-inventory', JSON.stringify(inventory));
                
                // 关闭模态框
                document.querySelector('.modal:last-child').remove();
                currentModalItemId = null;
                
                // 更新列表
                renderInventoryList();
                updateReminders();
                
                alert('项目编辑成功！');
            }
            
            // 打开幼虫羽化模态框
            function openMetamorphosisModal(id) {
                const item = inventory.find(item => item.id === id);
                if (!item) return;
                
                // 如果不是幼虫，不能进行羽化操作
                if (item.gender !== '幼虫') {
                    alert('只有幼虫项目可以进行羽化操作。');
                    return;
                }
                
                // 如果幼虫数量为0，不能进行羽化操作
                if (item.quantity <= 0) {
                    alert('幼虫数量为0，无法进行羽化操作。');
                    return;
                }
                
                currentModalItemId = id;
                
                // 创建模态框
                const modalHTML = `
                <div class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title"><i class="fas fa-bug"></i> 幼虫羽化记录</h3>
                            <button class="close-modal">&times;</button>
                        </div>
                        <div class="modal-body">
                            <p style="margin-bottom: 20px; font-weight: 600; font-size: 1.1rem; color: var(--text-color);">
                                ${item.name}${item.subcategory ? ` (${item.subcategory})` : ''} - 幼虫数量: ${item.quantity}
                            </p>
                            
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="modal-metamorphosis-gender"><i class="fas fa-venus-mars"></i> 羽化后性别</label>
                                    <select id="modal-metamorphosis-gender">
                                        <option value="">选择性别</option>
                                        <option value="公">公</option>
                                        <option value="母">母</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="modal-metamorphosis-size"><i class="fas fa-ruler"></i> 成虫尺寸 (mm)</label>
                                    <input type="text" id="modal-metamorphosis-size" placeholder="例如：70-85" value="${item.size || ''}">
                                </div>
                                
                                <div class="form-group">
                                    <label for="modal-metamorphosis-price"><i class="fas fa-yen-sign"></i> 成虫单价 (¥)</label>
                                    <input type="number" id="modal-metamorphosis-price" min="0" step="0.01" value="${item.price}" placeholder="留空则使用幼虫单价">
                                </div>
                                
                                <div class="form-group">
                                    <label for="modal-metamorphosis-date"><i class="fas fa-calendar-day"></i> 羽化日期</label>
                                    <input type="date" id="modal-metamorphosis-date" value="${new Date().toISOString().split('T')[0]}">
                                </div>
                                
                                <div class="form-group">
                                    <label for="modal-metamorphosis-notes"><i class="fas fa-sticky-note"></i> 备注 (可选)</label>
                                    <input type="text" id="modal-metamorphosis-notes" placeholder="例如：成功羽化，体型较大">
                                </div>
                            </div>
                            
                            <div style="padding: 15px; background-color: #fff3e0; border-radius: 10px; border: 1px solid #ffcc80; margin-top: 20px;">
                                <p style="font-size: 0.95rem; color: #e65100; margin: 0;">
                                    <i class="fas fa-exclamation-triangle"></i> 执行此操作后，原幼虫项目数量将减1，并创建一个新的成虫项目。
                                </p>
                            </div>
                            
                            <div class="button-group" style="margin-top: 30px;">
                                <button id="modal-save-metamorphosis" class="btn-primary" style="flex: 1; background: linear-gradient(135deg, #ff5722, #e64a19);">
                                    <i class="fas fa-bug"></i> 确认羽化
                                </button>
                                <button id="modal-cancel-metamorphosis" class="btn-secondary" style="flex: 1;">
                                    取消
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                `;
                
                // 添加模态框到页面
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                
                // 显示模态框
                const modal = document.querySelector('.modal:last-child');
                modal.style.display = 'flex';
                
                // 绑定事件
                modal.querySelector('.close-modal').addEventListener('click', () => {
                    modal.remove();
                    currentModalItemId = null;
                });
                
                modal.querySelector('#modal-cancel-metamorphosis').addEventListener('click', () => {
                    modal.remove();
                    currentModalItemId = null;
                });
                
                modal.querySelector('#modal-save-metamorphosis').addEventListener('click', saveMetamorphosis);
                
                // 点击模态框外部关闭
                modal.addEventListener('click', function(event) {
                    if (event.target === this) {
                        modal.remove();
                        currentModalItemId = null;
                    }
                });
            }
            
            // 保存羽化记录
            function saveMetamorphosis() {
                const gender = document.getElementById('modal-metamorphosis-gender').value;
                const size = document.getElementById('modal-metamorphosis-size').value.trim();
                const price = parseFloat(document.getElementById('modal-metamorphosis-price').value) || 0;
                const date = document.getElementById('modal-metamorphosis-date').value;
                const notes = document.getElementById('modal-metamorphosis-notes').value.trim();
                
                // 验证必填项
                if (!gender) {
                    alert('请选择羽化后的性别');
                    document.getElementById('modal-metamorphosis-gender').focus();
                    return;
                }
                
                if (!date) {
                    alert('请选择羽化日期');
                    document.getElementById('modal-metamorphosis-date').focus();
                    return;
                }
                
                // 查找原始幼虫项目
                const larvaIndex = inventory.findIndex(item => item.id === currentModalItemId);
                if (larvaIndex === -1) return;
                
                const larvaItem = inventory[larvaIndex];
                
                // 验证幼虫数量
                if (larvaItem.quantity <= 0) {
                    alert('幼虫数量不足，无法进行羽化操作。');
                    document.querySelector('.modal:last-child').remove();
                    currentModalItemId = null;
                    return;
                }
                
                // 1. 减少原幼虫项目数量
                inventory[larvaIndex].quantity -= 1;
                inventory[larvaIndex].updatedAt = new Date().toISOString();
                
                // 如果幼虫数量为0，从库存中移除
                if (inventory[larvaIndex].quantity === 0) {
                    inventory.splice(larvaIndex, 1);
                }
                
                // 2. 创建新的成虫项目，保留幼虫换土历史记录
                let adultChangeHistory = [];
                
                // 复制幼虫的换土历史记录（如果存在）
                if (larvaItem.changeHistory && larvaItem.changeHistory.length > 0) {
                    adultChangeHistory = JSON.parse(JSON.stringify(larvaItem.changeHistory));
                }
                
                // 添加羽化记录到历史记录中
                adultChangeHistory.push({
                    date: date,
                    notes: notes ? `羽化记录: ${notes}` : '幼虫羽化为成虫'
                });
                
                const newAdultItem = {
                    id: generateId(),
                    name: larvaItem.name,
                    subcategory: larvaItem.subcategory || '',
                    size: size || larvaItem.size || '',
                    gender: gender,
                    quantity: 1,
                    price: price > 0 ? price : larvaItem.price,
                    lastChangeDate: '',
                    nextChangeDate: '',
                    changeHistory: adultChangeHistory,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    metamorphosisFrom: {
                        larvaId: larvaItem.id,
                        date: date,
                        originalSize: larvaItem.size,
                        notes: notes || '幼虫羽化'
                    },
                    larvaHistoryPreserved: true
                };
                
                // 3. 添加到库存
                inventory.push(newAdultItem);
                
                // 4. 保存到本地存储
                localStorage.setItem('beetle-inventory', JSON.stringify(inventory));
                
                // 5. 关闭模态框
                document.querySelector('.modal:last-child').remove();
                currentModalItemId = null;
                
                // 6. 更新列表
                renderInventoryList();
                updateReminders();
                
                // 7. 显示成功消息
                alert('羽化记录已保存！原幼虫数量减1，已创建新的成虫项目并保留幼虫时期的换土历史记录。');
            }
            
            // 打开历史记录模态框
            function openHistoryModal(id) {
                const item = inventory.find(item => item.id === id);
                if (!item) return;
                
                // 如果没有换土历史记录，不显示
                if (!item.changeHistory || item.changeHistory.length === 0) {
                    alert('此项目没有换土历史记录。');
                    return;
                }
                
                currentModalItemId = id;
                
                let historyHTML = '';
                
                // 按日期排序（最近的在前面）
                const sortedHistory = [...item.changeHistory].sort((a, b) => {
                    return new Date(b.date) - new Date(a.date);
                });
                
                sortedHistory.forEach(record => {
                    const historyDate = new Date(record.date).toLocaleDateString();
                    // 标记羽化记录
                    const isMetamorphosisRecord = record.notes && record.notes.includes('羽化记录');
                    const recordClass = isMetamorphosisRecord ? 'style="background-color: #fff3e0; padding: 12px; border-radius: 8px; border-left: 4px solid #ff9800; margin-bottom: 10px;"' : 'style="background-color: #f0f9f0; padding: 12px; border-radius: 8px; border-left: 4px solid #4caf50; margin-bottom: 10px;"';
                    
                    historyHTML += `
                    <div ${recordClass}>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="font-weight: 600;"><i class="fas fa-calendar-day"></i> ${historyDate}</span>
                            ${isMetamorphosisRecord ? '<span style="color: #ff9800; font-weight: 600;">羽化记录</span>' : ''}
                        </div>
                        <div style="margin-top: 5px;">${record.notes || '换土记录'}</div>
                    </div>
                    `;
                });
                
                // 创建模态框
                const modalHTML = `
                <div class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title"><i class="fas fa-history"></i> 换土历史记录</h3>
                            <button class="close-modal">&times;</button>
                        </div>
                        <div class="modal-body">
                            <p style="margin-bottom: 20px; font-weight: 600; font-size: 1.1rem; color: var(--text-color);">
                                ${item.name}${item.subcategory ? ` (${item.subcategory})` : ''}
                                ${item.metamorphosisFrom && item.larvaHistoryPreserved ? '<span style="color: #ff9800; font-size: 0.9rem;"> (羽化生成，保留幼虫时期记录)</span>' : ''}
                            </p>
                            
                            <div id="modal-history-list">
                                ${historyHTML}
                            </div>
                            
                            <div class="button-group" style="margin-top: 30px;">
                                <button id="modal-close-history" class="btn-secondary" style="flex: 1;">
                                    关闭
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                `;
                
                // 添加模态框到页面
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                
                // 显示模态框
                const modal = document.querySelector('.modal:last-child');
                modal.style.display = 'flex';
                
                // 绑定事件
                modal.querySelector('.close-modal').addEventListener('click', () => {
                    modal.remove();
                    currentModalItemId = null;
                });
                
                modal.querySelector('#modal-close-history').addEventListener('click', () => {
                    modal.remove();
                    currentModalItemId = null;
                });
                
                // 点击模态框外部关闭
                modal.addEventListener('click', function(event) {
                    if (event.target === this) {
                        modal.remove();
                        currentModalItemId = null;
                    }
                });
            }
            
            // 更新子分类列表
            function updateSubcategories(name, subcategory) {
                if (!subcategory) return;
                
                if (!subcategories[name]) {
                    subcategories[name] = [];
                }
                
                if (!subcategories[name].includes(subcategory)) {
                    subcategories[name].push(subcategory);
                    localStorage.setItem('beetle-subcategories', JSON.stringify(subcategories));
                }
            }
            
            // 保存到本地存储
            function saveToLocalStorage() {
                localStorage.setItem('beetle-inventory', JSON.stringify(inventory));
                localStorage.setItem('beetle-sales', JSON.stringify(sales));
                localStorage.setItem('beetle-item-names', JSON.stringify(itemNames));
                localStorage.setItem('beetle-subcategories', JSON.stringify(subcategories));
                
                // 添加保存成功的视觉反馈
                const saveBtn = document.getElementById('save-local');
                const originalText = saveBtn.innerHTML;
                saveBtn.innerHTML = '<i class="fas fa-check"></i> 保存成功';
                saveBtn.style.backgroundColor = '#4caf50';
                
                setTimeout(() => {
                    saveBtn.innerHTML = originalText;
                    saveBtn.style.backgroundColor = '';
                }, 1500);
                
                alert('数据已保存到本地存储！');
            }
            
            // 从本地存储加载
            function loadFromLocalStorage() {
                const savedInventory = JSON.parse(localStorage.getItem('beetle-inventory'));
                const savedSales = JSON.parse(localStorage.getItem('beetle-sales'));
                const savedItemNames = JSON.parse(localStorage.getItem('beetle-item-names'));
                const savedSubcategories = JSON.parse(localStorage.getItem('beetle-subcategories'));
                
                if (savedInventory) {
                    inventory = savedInventory;
                    sales = savedSales || [];
                    itemNames = savedItemNames || [];
                    subcategories = savedSubcategories || {};
                    renderInventoryList();
                    renderSalesList();
                    updateReminders();
                    updateSalesStats();
                    
                    // 添加加载成功的视觉反馈
                    const loadBtn = document.getElementById('load-local');
                    const originalText = loadBtn.innerHTML;
                    loadBtn.innerHTML = '<i class="fas fa-check"></i> 加载成功';
                    loadBtn.style.backgroundColor = '#4caf50';
                    
                    setTimeout(() => {
                        loadBtn.innerHTML = originalText;
                        loadBtn.style.backgroundColor = '';
                    }, 1500);
                    
                    alert('数据已从本地存储加载！');
                } else {
                    alert('本地存储中没有找到数据！');
                }
            }
            
            // 导出为JSON文件
            function exportToJSON() {
                const data = {
                    inventory: inventory,
                    sales: sales,
                    itemNames: itemNames,
                    subcategories: subcategories,
                    exportedAt: new Date().toISOString()
                };
                
                const dataStr = JSON.stringify(data, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const exportFileDefaultName = `甲虫库存_${new Date().toISOString().slice(0,10)}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
            }
            
            // 导入JSON文件
            function importFromJSON() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                
                input.onchange = function(event) {
                    const file = event.target.files[0];
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        try {
                            const data = JSON.parse(e.target.result);
                            
                            if (data.inventory) {
                                inventory = data.inventory;
                                sales = data.sales || [];
                                itemNames = data.itemNames || [];
                                subcategories = data.subcategories || {};
                                
                                localStorage.setItem('beetle-inventory', JSON.stringify(inventory));
                                localStorage.setItem('beetle-sales', JSON.stringify(sales));
                                localStorage.setItem('beetle-item-names', JSON.stringify(itemNames));
                                localStorage.setItem('beetle-subcategories', JSON.stringify(subcategories));
                                
                                renderInventoryList();
                                renderSalesList();
                                updateReminders();
                                updateSalesStats();
                                alert('数据导入成功！');
                            } else {
                                alert('文件格式不正确！');
                            }
                        } catch (error) {
                            alert('导入失败：' + error.message);
                        }
                    };
                    
                    reader.readAsText(file);
                };
                
                input.click();
            }
            
            // 清空所有数据
            function clearAllData() {
                if (confirm('确定要清空所有数据吗？此操作将清空库存、销售记录和所有其他数据，不可撤销！')) {
                    inventory = [];
                    sales = [];
                    itemNames = [];
                    subcategories = {};
                    localStorage.removeItem('beetle-inventory');
                    localStorage.removeItem('beetle-sales');
                    localStorage.removeItem('beetle-item-names');
                    localStorage.removeItem('beetle-subcategories');
                    renderInventoryList();
                    renderSalesList();
                    updateReminders();
                    updateSalesStats();
                    alert('所有数据已清空！');
                }
            }
            
            // 清空销售记录
            function clearSalesData() {
                if (confirm('确定要清空所有销售记录吗？此操作不可撤销！')) {
                    sales = [];
                    localStorage.setItem('beetle-sales', JSON.stringify(sales));
                    renderSalesList();
                    updateSalesStats();
                    updateStats();
                    alert('销售记录已清空！');
                }
            }
            
            // 事件监听
            document.getElementById('add-item').addEventListener('click', addItem);
            document.getElementById('clear-form').addEventListener('click', clearForm);
            document.getElementById('save-local').addEventListener('click', saveToLocalStorage);
            document.getElementById('load-local').addEventListener('click', loadFromLocalStorage);
            document.getElementById('export-json').addEventListener('click', exportToJSON);
            document.getElementById('import-json').addEventListener('click', importFromJSON);
            document.getElementById('clear-data').addEventListener('click', clearAllData);
            document.getElementById('clear-sales').addEventListener('click', clearSalesData);
            
            // 设置默认日期为今天
            const today = new Date();
            document.getElementById('item-change-date').valueAsDate = today;
            
            // 性别选择变化时，控制换土时间字段
            document.getElementById('item-gender').addEventListener('change', function() {
                const gender = this.value;
                const changeDateField = document.getElementById('item-change-date');
                
                if (!needsSoilChange(gender)) {
                    // 成虫不需要换土时间
                    changeDateField.value = '';
                    changeDateField.disabled = true;
                } else {
                    changeDateField.disabled = false;
                    if (!changeDateField.value) {
                        const today = new Date().toISOString().split('T')[0];
                        changeDateField.value = today;
                    }
                }
            });
            
            // 初始渲染
            renderInventoryList();
            renderSalesList();
            updateReminders();
            updateSalesStats();
        });
    </script>
</body>
</html>
